<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" />
<style>
  :root {
    --main-bg: #262e46; --primary: #3b8bee; --accent: #ffe05b; --danger: #e94f37; --radius: 16px;
  }
  html, body { height: 100%; margin: 0; font-family: 'Montserrat', Arial, sans-serif; background: var(--main-bg); color: #fff;}
  .page { display: none; min-height:calc(100vh - 100px); padding:30px 18px; box-sizing:border-box; flex-direction:column; align-items:center;}
  .show {display:flex;}
  h2, h1 {font-weight:700; margin-bottom:20px;}
  button {font-size:1.15em; border-radius:36px; background:var(--primary); color:#fff; font-weight:700; border:none; padding:13px 34px; margin:14px 10px;}
  button:hover:not(:disabled) {background:var(--accent); color:#232323;}
  input[type=text], input[type=password], input[type=email] {
    font-size:1.16em; padding:10px 15px; border-radius:12px; border:none; width:210px; margin:8px 2px 15px 2px; text-align:center; background:#344365; color:#fff;}
  input[type=file] {margin:10px 0;}
  input::placeholder {color:#bac3e6;}
  .footer { text-align:center;color:#ffe05b;margin:20px 0 8px;font-size:1em;font-weight:700;letter-spacing:0.10em;}
  .avatar-preview { width: 58px; height: 58px; border-radius: 50%; margin-bottom:8px; object-fit:cover;}
  .buzzer-btn {background:var(--accent);color:#232323;font-size:4em;padding:36px 74px;border-radius:140px;font-weight:800;margin:24px 0;border:8px solid #fff;}
  .buzzer-btn:disabled {background:#eee;color:#999; border-color:#ccc;}
  .scoreboard {background:#222947;border-radius:16px;padding:6px 0;box-shadow:0 2px 14px #233d;width:340px;max-width:95%;margin-top:12px;}
  .score-row {display:flex;align-items:center; border-radius:9px; margin-bottom:8px; background:#fff2; padding:8px 4px;}
  .rank {background:var(--primary);color:#fff;font-weight:700;width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-right:8px;}
  .pname {flex:1;font-weight:700;font-size:1.1em;color:var(--accent);}
  .pscore {font-size:1.15em;font-weight:700;margin-right:16px;}
  .buzzed-tag {background:var(--accent); color:#232323; border-radius:10px; padding:4px 11px; font-size:1.15em; margin-left:9px;}
  #buzz-lock-msg {color:var(--accent);margin:15px 0 0 0;font-weight:700;}
  .host-controls-row {display:flex;justify-content:flex-start;gap:10px;width:340px;max-width:95%;margin:18px 0 5px 0;}
  .admin-controls {display:inline-flex; gap:7px; align-items:center;}
  .admin-controls button {font-size:1em;padding:4px 11px;border-radius:8px;}
  #admin-question-text,#player-question-text {font-size:1.75em;font-weight:700;margin:9px 0;word-break:break-word;}
  #admin-question-img,#player-question-img {max-width:90vw;max-width:520px;max-height:290px;display:block;margin:13px auto;border-radius:20px;}
  #player-question-img {margin-bottom:18px;}
  .center-box {background:#2b3250;border-radius:24px;box-shadow:0 4px 32px #232f;max-width:420px;width:92%;padding:24px 18px;}
  .backbtn {position:fixed;bottom:22px;left:50%;transform:translateX(-50%);font-size:1.1em;padding:10px 36px;border-radius:40px;background:#364063;color:white;border:none;cursor:pointer;box-shadow:0 3px 9px #0008;user-select:none;z-index:999;transition:background 0.2s;}
  .backbtn:hover {background:var(--accent);color:#232323;}
</style>
</head>
<body>
<button class="backbtn" id="backbtn" style="display:none" onclick="backButtonHandler()">‚Üê Back</button>
<div id="modal"></div>

<!-- Admin Game Panel -->
<div id="page-admin-panel" class="page">
  <div class="center-box">
    <h2>Admin Control</h2>
    <div>Game Code: <span id="roomcode"></span></div>
    <div>Round: <span id="round-label"></span></div>
    <div>
      <b>Current Question:</b>
      <div id="admin-question-text" style="margin-top:6px;"></div>
      <img id="admin-question-img" src="" style="display:none"/>
    </div>
    <input type="text" id="admin-question-input" placeholder="Enter question here"/><br />
    <input type="file" id="admin-image-file" accept="image/*"/>
    <img id="admin-image-preview" style="display:none;max-width:220px;max-height:160px;"/>
    <div class="host-controls-row">
      <button onclick="resetBuzzers()">Reset Buzzer</button>
      <button onclick="resetRound()">Reset Round</button>
      <button onclick="nextRound()">Next Round</button>
    </div>
    <div class="scoreboard" id="admin-scores"></div>
    <div id="buzzed-who" style="margin-top:12px;"></div>
    <div id="footer">DEVELOPED BY AMUTAN GROUP</div>
  </div>
</div>

<!-- Player Page -->
<div id="page-player" class="page">
  <div class="center-box">
    <h2>Quiz Buzzer</h2>
    <img id="player-avatar-preview" class="avatar-preview" style="display:none"/>
    <div class="pname" style="font-size:1.25em;"> <span id="pl-name"></span></div>
    <div>Game Code: <span id="pl-room"></span></div>
    <div>Team: <span id="pl-team"></span></div>
    <div id="player-question-text" style="margin:18px 0 8px 0;"></div>
    <img id="player-question-img" src="" style="display:none;"/>
    <button id="player-buzzer" class="buzzer-btn" onclick="buzz()">BUZZ!</button>
    <div id="buzz-lock-msg"></div>
    <div class="scoreboard" id="player-scores"></div>
    <div id="footer">DEVELOPED BY AMUTAN GROUP</div>
  </div>
</div>

<!-- The rest of app (login/register, home, etc) goes here,
     unchanged from previous code for brevity. Please use as before. -->

<script>
/* --- Firebase config, app setup, and rest unchanged --- */

// (For brevity, only admin/player panel and core functions shown here.
  For full app structure, add previous login/register/home/profile/user admin code above.)

// In readAdmin() and listenPlayer(), ensure only the first buzz is shown/handled:
function readAdmin() {
  db.ref("games/"+gameID).on("value", snap => {
    const g = snap.val();
    document.getElementById("round-label").textContent = g.round || 1;
    document.getElementById("admin-question-text").textContent = g.question || "";
    let imgTag = document.getElementById("admin-question-img");
    if(g.image && g.image.length){
      imgTag.src = g.image;
      imgTag.style.display = "block";
    } else {
      imgTag.src = ""; imgTag.style.display = "none";
    }
    const p = g.players || {};
    let arr = Object.entries(p).map(([id,v])=>({...v,id}));
    arr.sort((a,b)=>(b.score||0)-(a.score||0));
    let buzzedID = g.buzzed;
    let buzzedPlayer = arr.find(x=>x.id===buzzedID);
    let who = buzzedPlayer ? `<span class="buzzed-tag">üîî ${buzzedPlayer.name}</span>` : "";
    document.getElementById("buzzed-who").innerHTML = who;
    let html = "";
    arr.forEach((pl,i)=>{
      html += `<div class="score-row">
      <span class="rank">${i+1}</span>
      <span class="pname" style="color:#ffe05b;">${pl.name}${pl.team?' ('+pl.team+')':''}</span>
      <span class="pscore">${pl.score||0}</span>
      <span class="admin-controls">
        <button onclick="adminScore(25, '${pl.id}')">+25</button>
        <button onclick="adminScore(-25, '${pl.id}')">-25</button>
      </span>
      ${pl.id===buzzedID?'<span class="buzzed-tag">Buzzed</span>':""}
      </div>`;
    });
    document.getElementById("admin-scores").innerHTML = html || "(no players yet)";
  });
}

function listenPlayer() {
  db.ref("games/"+gameID).on("value", snap => {
    const g = snap.val();
    document.getElementById("buzz-lock-msg").textContent = g.buzzed ? "Buzzer is locked!" : "";
    let arr = Object.entries(g.players || {}).map(([id,v])=>({...v,id}));
    arr.sort((a,b)=>(b.score||0)-(a.score||0));
    let buzzedID = g.buzzed;
    let html = "";
    arr.forEach((pl,i)=>{
      html += `<div class="score-row">
      <span class="rank">${i+1}</span>
      <span class="pname" style="color:#ffe05b;">${pl.name}${pl.team?' ('+pl.team+')':''}</span>
      <span class="pscore">${pl.score||0}</span>
      ${pl.id===buzzedID?'<span class="buzzed-tag">Buzzed</span>':""}
      </div>`;
    });
    document.getElementById("player-scores").innerHTML = html || "(no players yet)";
    let buzzerPressed = buzzedID;
    document.getElementById("player-buzzer").disabled = buzzerPressed && buzzerPressed !== myPID;
    if(buzzerPressed && !buzzLockSoundPlayed){
      let audio = document.getElementById("buzz-audio");
      audio.currentTime = 0; audio.play();
      buzzLockSoundPlayed=true;
    }
    if(!buzzerPressed) buzzLockSoundPlayed=false;
  });
}

// The rest of question-, avatar-, and profile management unchanged from previous full working code.

</script>
<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>
</body>
</html>
