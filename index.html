<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Buzzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {
    margin:0; padding:0; height:100%; font-family:'Montserrat', Arial, sans-serif;
    background: var(--main-bg); color: #fff;
    user-select:none;
  }
  .page {
    display: none; max-width: 720px; margin: 0 auto; padding: 28px 32px;
  }
  .show { display: block; }
  h1,h2,h3 {
    font-weight:700; margin-bottom: 24px; text-align:center;
  }
  input[type=text], input[type=password], input[type=email], input[type=file] {
    width: 100%; max-width: 420px; padding: 14px 18px; font-size: 1.2em;
    border-radius: var(--radius); border: none; margin: 12px auto 24px auto;
    background: #344365; color: #fff; box-sizing: border-box; text-align: center;
  }
  input::placeholder { color: #bac3e6; }
  button, .buzzer-btn {
    background: var(--primary);
    color: #fff;
    font-family: Montserrat;
    font-weight: 700;
    font-size: 1.3em;
    border: none;
    border-radius: 48px;
    padding: 18px 20px;
    cursor: pointer;
    box-shadow: 0 6px 13px #2554a180;
    user-select: none;
    transition: background 0.2s ease;
    text-align: center;
    min-width: 180px;
    max-width: 320px;
    margin: 18px auto;
    display: block;
  }
  button:hover:not(:disabled), .buzzer-btn:hover:not(:disabled) { background: var(--accent); color: #232323; }
  button:disabled, .buzzer-btn:disabled { background: #ddd; color: #999; cursor: not-allowed; box-shadow: none; }
  .buzzer-btn {
    background: var(--accent);
    color: #141c34;
    font-size: 4rem;
    font-weight: 900;
    padding: 48px 120px;
    border-radius: 90px;
    border: 8px solid #fff;
    box-shadow: 0 8px 32px #ffea6fcc;
    margin: 38px auto;
    min-width: 0; max-width: none;
    text-align: center;
  }
  .backbtn {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.3em;
    padding: 12px 40px;
    border-radius: 44px;
    background: #364063;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 5px 16px #000a;
    user-select: none;
    z-index: 1100;
    transition: background 0.3s ease;
  }
  .backbtn:hover {
    background: var(--accent);
    color: #232323;
  }
  .scoreboard {
    max-width: 720px;
    margin: 30px auto;
    background: #222947;
    padding: 18px 28px;
    box-shadow: 0 2px 14px #0008;
    border-radius: 20px;
    color: #fff;
    overflow-x: auto;
  }
  table {
    width: 100%; border-collapse: collapse; color: #fff;
  }
  thead tr {
    background: var(--primary);
  }
  th, td {
    padding: 14px 10px; border: 1px solid #1a2138; text-align: center;
  }
  tbody tr:nth-child(odd) {
    background: #2a2f4b;
  }
  tbody tr:hover {
    background-color: #3b8bee90;
  }
  .avatar-column img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  .buzzed-tag {
    background: var(--accent);
    color: #232323;
    border-radius: 14px;
    padding: 6px 14px;
    font-size: 1.1em;
    user-select: none;
    font-weight: 700;
  }
  #buzz-lock-msg, #buzzed-who {
    color: var(--accent);
    font-weight: 700;
    text-align: center;
    user-select: none;
  }
  #buzz-lock-msg {
    margin-top: 15px;
    font-size: 1.3em;
  }
  #buzzed-who {
    font-size: 1.8em;
    margin: 30px 0 24px 0;
  }
  #question-text, #player-question-text {
    font-size: 2.9em;
    font-weight: 900;
    margin: 30px auto 24px auto;
    max-width: 90vw;
    word-break: break-word;
    text-align: center;
  }
  #question-img, #player-question-img {
    max-width: 90vw;
    max-height: 400px;
    border-radius: 24px;
    margin: 0 auto 30px auto;
    display: block;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
    z-index: 1;
  }
  #question-img.zoomed, #player-question-img.zoomed {
    transform: scale(2);
    cursor: zoom-out;
    position: relative;
    z-index: 9999;
    box-shadow: 0 0 20px #ffea6fcc;
  }
  .flex-main {
    display: flex;
    min-height: 100vh;
    align-items: stretch;
    justify-content: stretch;
  }
  .left-panel {
    flex: 1 1 50%;
    background: #21253e;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    min-width: 0;
  }
  .right-panel {
    flex: 1 1 50%;
    background: #293054;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-width: 350px;
    padding: 0 32px 40px 32px;
  }
  #buzzer-container {
    margin-top: 48px;
    text-align: center;
    width: 100%;
  }
  .toggle-btns {
    margin: 24px 0 12px 0;
    display: flex;
    justify-content: center;
    gap: 20px;
  }
  .toggle-btns button {
    width: 140px;
  }
  #host-controls {
    margin-top: 26px;
    padding: 14px 22px;
    background: #193048;
    border-radius: 20px;
    width: 100%;
    max-width: 400px;
    color: #ffe05b;
    font-weight: 700;
  }
  #host-controls input, #host-controls button {
    font-size: 1em;
    border-radius: 10px;
  }
  #host-controls input {
    padding: 8px 12px;
    width: 100px;
    margin-right: 12px;
    border: none;
  }
  #host-controls button {
    width: 100px;
    padding: 9px 0;
    border: none;
    cursor: pointer;
  }
  @media (max-width: 900px) {
    .flex-main {
      flex-direction: column;
    }
    .left-panel, .right-panel {
      min-width: 0;
      width: 100%;
    }
    #question-img, #player-question-img {
      max-height: 250px;
    }
  }
</style>
</head>
<body>
<audio id="buzz-audio" preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/06/14/audio_123e37b08f.mp3" type="audio/mp3" />
</audio>

<button class="backbtn" id="backbtn" style="display:none;" onclick="backButtonHandler()">‚Üê Back</button>

<div class="flex-main">
  <div class="left-panel">
    <img id="question-img" src="" alt="Question Image" />
    <div id="question-text"></div>
  </div>
  <div class="right-panel">
    <div id="buzzer-container">
      <button id="buzzer-btn" class="buzzer-btn">BUZZ!</button>
      <div id="buzz-lock-msg"></div>
    </div>
    <div class="toggle-btns">
      <button id="individual-score-btn">Individual Scores</button>
      <button id="team-score-btn">Team Scores</button>
    </div>
    <div id="scoreboard-box" class="scoreboard"></div>
    <div id="host-controls" style="display:none;">
      <label for="host-teamname">Team Name:</label>
      <input id="host-teamname" placeholder="Team Name" />
      <label for="host-points">Points:</label>
      <input id="host-points" type="number" value="10" />
      <button id="add-points-btn">Add Points</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
  authDomain: "buzzer-a0d53.firebaseapp.com",
  databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "buzzer-a0d53",
  storageBucket: "buzzer-a0d53.appspot.com",
  messagingSenderId: "29031182202",
  appId: "1:29031182202:web:447d951b38be59b29270c3",
  measurementId: "G-NP0DMX7TKJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Demo data you replace with real user/game initialization
let isHost = true; // Set to false for normal players
let myUser = "host"; // host or player username
let myPID = "pid_host"; // player's unique ID in DB
let myTeam = null;
let gameID = "123456";

document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
const buzzerBtn = document.getElementById('buzzer-btn');
const buzzAudio = document.getElementById('buzz-audio');
const questionImg = document.getElementById('question-img');
const questionText = document.getElementById('question-text');
const buzzLockMsg = document.getElementById('buzz-lock-msg');
const scoreboardBox = document.getElementById('scoreboard-box');
const individualScoreBtn = document.getElementById('individual-score-btn');
const teamScoreBtn = document.getElementById('team-score-btn');
const addPointsBtn = document.getElementById('add-points-btn');

let buzzerLocked = false;
let lastBuzz = 0;
let scoreboardMode = 'individual';

// Function to play buzzer sound instantly
function playBuzzSound() {
  buzzAudio.currentTime = 0;
  buzzAudio.play().catch(()=>{});
}

// Function to trigger buzz with fast debounce (16 ms) for spacebar and mouse
function triggerBuzz() {
  if (buzzerLocked) return;
  let now = performance.now();
  if (now - lastBuzz < 16) return;
  lastBuzz = now;
  // Update buzz in firebase
  db.ref(`games/${gameID}`).update({ buzzed: myPID });
  db.ref(`games/${gameID}/players/${myPID}`).update({ buzzed: true });
  playBuzzSound();
  updateBuzzLock(true);
}

// Disable buzzer according to game state
function updateBuzzLock(lock) {
  buzzerLocked = lock;
  buzzLockMsg.textContent = lock ? "Buzzer Locked!" : "";
  buzzerBtn.disabled = lock;
}

// Listen to buzz state changes in DB to update buzzer lock state
db.ref(`games/${gameID}/buzzed`).on('value', snap => {
  const val = snap.val();
  if (val && val !== myPID) {
    updateBuzzLock(true);
  } else {
    updateBuzzLock(false);
  }
});

// Listen to question data updates (text and image)
db.ref(`games/${gameID}`).on('value', snap => {
  const data = snap.val() || {};
  questionText.textContent = data.question || "Waiting for question...";
  if (data.image) {
    questionImg.src = data.image;
    questionImg.style.display = 'block';
  } else {
    questionImg.style.display = 'none';
  }
});

// Zoom toggle on question image
questionImg.addEventListener('click', () => {
  if (questionImg.style.display === 'none') return;
  questionImg.classList.toggle('zoomed');
});

// Handle buzzer interaction
buzzerBtn.addEventListener('click', triggerBuzz);
window.addEventListener('keydown', e => {
  if (e.code === "Space" || e.keyCode === 32) {
    e.preventDefault();
    triggerBuzz();
  }
});

// Load scoreboard - individual or team mode
function loadScoreboard(mode) {
  scoreboardMode = mode;
  if (!gameID) return;
  db.ref(`games/${gameID}/players`).once("value").then(snap => {
    const players = snap.val() || {};
    let arr = Object.entries(players).map(([id, p]) => ({...p, id}));
    if (mode === 'individual') {
      arr.sort((a, b) => (b.score || 0) - (a.score || 0));
      let html = `<table><thead><tr><th>Player</th><th>Team</th><th>Score</th></tr></thead><tbody>`;
      arr.forEach(p => {
        html += `<tr><td>${p.name || p.id}</td><td>${p.team || "-"}</td><td>${p.score||0}</td></tr>`;
      });
      html += "</tbody></table>";
      scoreboardBox.innerHTML = html;
    } else {
      let teamScores = {};
      arr.forEach(p => {
        if (!p.team) return;
        teamScores[p.team] = (teamScores[p.team] || 0) + (p.score||0);
      });
      const sortedTeams = Object.entries(teamScores).sort(([,a], [,b]) => b - a);
      let html = `<table><thead><tr><th>Team</th><th>Total Points</th></tr></thead><tbody>`;
      sortedTeams.forEach(([team, score]) => {
        html += `<tr><td>${team}</td><td>${score}</td></tr>`;
      });
      html += "</tbody></table>";
      scoreboardBox.innerHTML = html;
    }
  });
}

// Initialize scoreboard buttons and load individual by default
individualScoreBtn.onclick = () => loadScoreboard('individual');
teamScoreBtn.onclick = () => loadScoreboard('team');
loadScoreboard('individual');

// Host controls: add points to team
addPointsBtn.onclick = () => {
  const team = document.getElementById('host-teamname').value.trim();
  const pts = parseInt(document.getElementById('host-points').value, 10);
  if(!team || isNaN(pts)) return alert('Enter valid team and points');
  db.ref(`games/${gameID}/players`).once('value').then(snap => {
    snap.forEach(playerSnap => {
      const p = playerSnap.val();
      if(p.team === team) {
        let key = playerSnap.key;
        let pScore = p.score || 0;
        db.ref(`games/${gameID}/players/${key}/score`).set(pScore + pts);
      }
    });
  });
};

// Player leaves
function leaveGame() {
  if (!myPID) return;
  db.ref(`games/${gameID}/players/${myPID}`).remove();
  db.ref(`games/${gameID}/buzzed`).once("value").then(snap => {
    if (snap.val() === myPID) db.ref(`games/${gameID}/buzzed`).remove();
  });
  alert('You left the game.');
  // Redirect or reset UI here as required
}

// Dummy initial setup - replace these in your app
if(!myUser) myUser = "guest";
document.getElementById("pl-name")?.textContent = myUser || "";
document.getElementById("pl-room")?.textContent = gameID || "";
document.getElementById("pl-team")?.textContent = myTeam || "";
if (typeof isHost !== "undefined" && isHost) {
  document.getElementById('host-controls').style.display = 'block';
} else {
  document.getElementById('host-controls').style.display = 'none';
}
</script>
</body>
</html>

