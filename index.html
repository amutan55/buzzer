<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Montserrat', sans-serif;
    background: var(--main-bg); color: #fff;
  }
  .page { display: none; max-width: 1200px; margin: 0 auto; padding: 28px; }
  .show { display: block; }
  h1,h2 { font-weight: 700; margin-bottom: 20px; text-align: center; }
  .input-box {
    width: 100%; max-width: 420px; padding: 14px 18px; font-size: 1.2em;
    border-radius: var(--radius); border: none; margin: 12px auto;
    background: #344365; color: #fff; text-align: center;
    outline: none; font-family: 'Montserrat', sans-serif;
  }
  button {
    background: var(--primary); color: #fff; font-weight: 700; font-size: 1.2em;
    border: none; border-radius: 30px; padding: 14px 26px; cursor: pointer;
    box-shadow: 0 4px 12px #0006; margin: 12px auto; display: block; font-family: 'Montserrat', sans-serif;
  }
  button:hover:not(:disabled) { background: var(--accent); color: #232323; }
  button:disabled { background: #555; color: #999; }
  .center-box {
    max-width: 480px; margin: 0 auto; padding: 24px; background: #2b3250;
    border-radius: 24px; box-shadow: 0 4px 20px #000a; text-align: center;
  }
  .buzzer-btn {
    background: var(--accent); color: #141c34; font-size: 3em; font-weight: 900;
    padding: 60px 100px; border-radius: 160px; border: 12px solid #fff;
    box-shadow: 0 12px 40px #ffea6fcc; cursor: pointer; user-select: none;
    margin: 24px auto;
  }
  .buzzer-btn:disabled { background: #aaa; color: #555; border-color: #666; box-shadow: none; }
  .player-layout { display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; align-items: center; }
  .player-left { flex: 1; min-width: 320px; max-width: 550px; text-align: center; }
  .player-right { flex: 1; min-width: 240px; max-width: 420px; text-align: center; }
  #player-question-text, #question-text {
    font-size: 2.2em; font-weight: 800; margin: 20px 0; text-align: center; font-family: 'Montserrat', sans-serif;
  }
  #player-question-img, #question-img {
    max-width: 100%; max-height: 320px; border-radius: 20px;
    margin: 10px auto; display: none; cursor: zoom-in;
    box-shadow: 0 0 10px #000a;
  }
  #player-question-img.zoomed, #question-img.zoomed {
    transform: scale(2); cursor: zoom-out; z-index: 999;
  }
  .scoreboard, #admin-scores, #scoreboard-table {
    background: #222947; border-radius: 20px; margin-top: 20px;
    box-shadow: 0 2px 14px #0008; overflow-x: auto;
    width: 100%;
  }
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--primary); }
  th, td { padding: 12px; text-align: center; border: 1px solid #1a2138; }
  .avatar-column img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  tbody tr:nth-child(odd) { background: #2a2f4b; }
  tbody tr:hover { background: #3b8bee90; }
  #modal {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: #ffe05bcc; padding: 12px 32px; border-radius: 12px;
    color: #232323; font-weight: 700; display: none; z-index: 9999;
  }
  .buzzed-tag {
    background: var(--accent); padding: 4px 10px; border-radius: 10px;
    color: #232323; font-weight: 700;
    font-family: 'Montserrat', sans-serif;
  }
  .avatar-preview {
    width: 72px; height: 72px; border-radius: 50%; object-fit: cover;
    box-shadow: 0 0 12px #12183fbb; margin-bottom: 14px; display: none;
  }
  .backbtn {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.3em;
    padding: 12px 40px;
    border-radius: 44px;
    background: #364063;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 5px 16px #000a;
    user-select: none;
    z-index: 1100;
    transition: background 0.3s ease;
  }
  .backbtn:hover {
    background: var(--accent);
    color: #232323;
  }
  select.role-dropdown { font-size:1em; margin: 0 auto; border-radius:10px; padding:5px 10px;}
</style>
</head>
<body>
<button class="backbtn" id="backbtn" style="display:none" onclick="backButtonHandler()">‚Üê Back</button>
<div id="modal"></div>

<!-- LOGIN -->
<div id="page-login" class="page show">
  <div class="center-box">
    <h1>Login</h1>
    <input id="login-username" class="input-box" autocomplete="off" placeholder="Username"/>
    <input type="password" id="login-password" class="input-box" placeholder="Password"/>
    <button onclick="loginUser()">Login</button>
    <button onclick="showRegister()">Register</button>
  </div>
</div>

<!-- REGISTER -->
<div id="page-register" class="page">
  <div class="center-box">
    <h1>Register</h1>
    <input id="register-username" class="input-box" autocomplete="off" placeholder="Username"/>
    <input type="password" id="register-password" class="input-box" placeholder="Password"/>
    <input id="register-email" class="input-box" placeholder="Email"/>
    <input type="file" id="register-avatar" accept="image/*"/>
    <img id="register-avatar-preview" class="avatar-preview"/>
    <button onclick="registerUser()">Register</button>
    <button onclick="showLogin()">Back</button>
  </div>
</div>

<!-- HOME -->
<div id="page-home" class="page">
  <div class="center-box">
    <h2>Welcome, <span id="welcome-user"></span></h2>
    <button onclick="hostPage()">Host Game</button>
    <button onclick="joinPage()">Join Game</button>
    <button onclick="showProfile()">Profile</button>
    <button id="adminPanelBtn" onclick="adminPanel()" style="display:none;">Admin Panel</button>
    <button onclick="showScoreboard()">Scoreboard</button>
    <button onclick="logoutUser()">Logout</button>
  </div>
</div>

<!-- PROFILE -->
<div id="page-profile" class="page">
  <div class="center-box">
    <h2>Your Profile</h2>
    <img id="profile-avatar-preview" class="avatar-preview"/>
    <input id="profile-nickname" class="input-box" readonly/>
    <input id="profile-password" type="password" class="input-box" placeholder="New Password"/>
    <input id="profile-email" class="input-box" placeholder="Email"/>
    <input type="file" id="profile-avatar" accept="image/*"/>
    <button onclick="updateProfile()">Save Changes</button>
  </div>
</div>

<!-- HOST PAGE -->
<div id="page-host" class="page">
  <div class="center-box">
    <h2>Host Game</h2>
    <label>Game Code:</label>
    <input id="host-code" class="input-box" readonly/>
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="page-admin-panel" class="page">
  <div class="center-box">
    <h2>Admin Panel</h2>
    <div><b>Game Code:</b> <span id="roomcode"></span></div>
    <div><b>Round:</b> <span id="round-label"></span></div>
    <div id="question-text"></div>
    <img id="question-img"/>
    <input id="admin-question-input" class="input-box" placeholder="Enter question"/>
    <input type="file" id="admin-image-file" accept="image/*"/>
    <img id="admin-image-preview" class="avatar-preview"/>
    <button onclick="uploadQuestion()">Upload Question</button>
    <br>
    <!-- Only admin controls below -->
    <button onclick="resetBuzzers()">Reset Buzzer</button>
    <button id="unlock-buzzer-btn" onclick="unlockBuzzers()" style="display:none;">Unlock Buzzer</button>
    <button onclick="lockBuzzers()">Lock Buzzers</button>
    <button onclick="nextRound()">Next Round</button>
    <button onclick="clearAllScores()">Clear Scores</button>
    <div id="buzzed-who"></div>
    <div id="admin-scores"></div>
    <div id="admin-userlist"></div>
  </div>
</div>

<!-- JOIN -->
<div id="page-join" class="page">
  <div class="center-box">
    <h2>Join Game</h2>
    <input id="join-code" class="input-box" maxlength="6" placeholder="Game Code"/>
    <input id="join-team" class="input-box" maxlength="24" placeholder="Team (optional)"/>
    <button onclick="joinGame()">Join</button>
  </div>
</div>

<!-- PLAYER -->
<div id="page-player" class="page">
  <div class="center-box">
    <div class="player-layout">
      <div class="player-left">
        <div id="player-question-text"></div>
        <img id="player-question-img"/>
      </div>
      <div class="player-right">
        <button id="player-buzzer" class="buzzer-btn" onclick="buzz()">BUZZ!</button>
        <div id="buzz-lock-msg"></div>
        <div class="scoreboard" id="player-scores"></div>
      </div>
    </div>
  </div>
</div>

<!-- SCOREBOARD -->
<div id="page-scoreboard" class="page">
  <div class="center-box">
    <h2>Overall Scoreboard</h2>
    <table id="scoreboard-table"></table>
  </div>
</div>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3"></audio>

<script>
const firebaseConfig={
  apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
  authDomain: "buzzer-a0d53.firebaseapp.com",
  databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "buzzer-a0d53",
  storageBucket: "buzzer-a0d53.appspot.com",
  messagingSenderId: "29031182202",
  appId: "1:29031182202:web:447d951b38be59b29270c3",
  measurementId: "G-NP0DMX7TKJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let gameID = "", myUser = "", myPID = "", myTeam = "", buzzLockSoundPlayed = false;
let pageHistory = [];

function showModal(msg) {
  const m = document.getElementById("modal");
  m.textContent = msg;
  m.style.display = "block";
  setTimeout(() => m.style.display = "none", 1800);
}
function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("show"));
  document.getElementById(id).classList.add("show");
  document.getElementById("backbtn").style.display = id === "page-login" ? "none" : "inline-block";
}
function navigateToPage(id) {
  if (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== id) {
    pageHistory.push(id);
  }
  showPage(id);
}
function backButtonHandler() {
  if (pageHistory.length > 1) {
    pageHistory.pop();
    showPage(pageHistory[pageHistory.length - 1]);
  }
}

function showRegister() { navigateToPage("page-register"); }
function showLogin() { navigateToPage("page-login"); }
function showHome() {
  document.getElementById("welcome-user").textContent = myUser;
  db.ref("users/" + myUser).get().then(snap => {
    document.getElementById("adminPanelBtn").style.display = (snap.val()?.role === "admin") ? "block" : "none";
  });
  navigateToPage("page-home");
}
function logoutUser() {
  myUser = "";
  myPID = "";
  myTeam = "";
  gameID = "";
  pageHistory = [];
  showLogin();
  showModal("Logged out");
}
function showProfile() { navigateToPage("page-profile"); }
function hostPage() {
  const code = String(Math.floor(Math.random() * 900000 + 100000));
  gameID = code;
  document.getElementById("host-code").value = code;
  db.ref("games/" + code).set({
    created: Date.now(),
    status: "waiting",
    round: 1,
    question: "",
    image: "",
    players: {},
    buzzed: "",
    lock: false
  });
  navigateToPage("page-host");
}
function startGame() {
  db.ref("games/" + gameID).update({ status: "live", round: 1 });
  document.getElementById("roomcode").textContent = gameID;
  listenAdmin();
  readAdminUserlist();
  navigateToPage("page-admin-panel");
  updateUnlockButton();
}
function joinPage() { navigateToPage("page-join"); }
function adminPanel() {
  db.ref("users/" + myUser).get().then(snap => {
    if (snap.val()?.role !== "admin") { showModal("Only admins can access!"); return; }
    readAdmin();
    readAdminUserlist();
    navigateToPage("page-admin-panel");
  });
}
function showScoreboard() { navigateToPage("page-scoreboard"); }

// Avatar preview for file inputs
function readAvatar(input, previewId) {
  if (input.files[0]) {
    let reader = new FileReader();
    reader.onload = e => {
      let img = document.getElementById(previewId);
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(input.files[0]);
  }
}
["register-avatar", "profile-avatar", "admin-image-file"].forEach(id => {
  document.getElementById(id).addEventListener("change", e => readAvatar(e.target, id === "admin-image-file" ? "admin-image-preview" : id + "-preview"));
});

// Authentication
function registerUser() {
  const username = document.getElementById("register-username").value.trim();
  const pw = document.getElementById("register-password").value.trim();
  const email = document.getElementById("register-email").value.trim();
  const avatarFile = document.getElementById("register-avatar").files[0];
  if (!username || !pw || !email) return showModal("Fill all fields.");
  db.ref("users/" + username).get().then(snap => {
    if (snap.exists()) return showModal("Username exists.");
    if (avatarFile) {
      let reader = new FileReader();
      reader.onload = e => {
        db.ref("users/" + username).set({ pw, email, role: "user", avatar: e.target.result }).then(() => {
          showModal("Registered! Please login.");
          setTimeout(showLogin, 1400);
        });
      };
      reader.readAsDataURL(avatarFile);
    } else {
      db.ref("users/" + username).set({ pw, email, role: "user", avatar: "" }).then(() => {
        showModal("Registered! Please login.");
        setTimeout(showLogin, 1400);
      });
    }
  });
}
function loginUser() {
  const username = document.getElementById("login-username").value.trim(),
    pw = document.getElementById("login-password").value.trim();
  if (username.toLowerCase() === "admin" && pw === "24207") {
    myUser = "admin";
    showHome();
    return;
  }
  db.ref("users/" + username).get().then(snap => {
    if (!snap.exists()) return showModal("User not found.");
    const user = snap.val();
    if (user.pw !== pw) return showModal("Incorrect password.");
    myUser = username;
    showHome();
  });
}
function updateProfile() {
  const email = document.getElementById("profile-email").value.trim(),
    password = document.getElementById("profile-password").value.trim(),
    avatarFile = document.getElementById("profile-avatar").files[0];
  let updateObj = {};
  if (email) updateObj.email = email;
  if (password) updateObj.pw = password;
  if (avatarFile) {
    let reader = new FileReader();
    reader.onload = e => {
      updateObj.avatar = e.target.result;
      db.ref("users/" + myUser).update(updateObj).then(() => {
        showModal("Profile updated.");
        showHome();
      });
    };
    reader.readAsDataURL(avatarFile);
  } else {
    db.ref("users/" + myUser).update(updateObj).then(() => {
      showModal("Profile updated.");
      showHome();
    });
  }
}
// Admin panel functions for question, buzzer lock/unlock, user-management, rounds, scores
function uploadQuestion() {
  const question = document.getElementById("admin-question-input").value.trim();
  const file = document.getElementById("admin-image-file").files[0];
  if (!question) return showModal("Please enter a question.");
  if (file) {
    let reader = new FileReader();
    reader.onload = e => {
      db.ref("games/" + gameID).update({ question, image: e.target.result });
      document.getElementById("admin-question-input").value = "";
      document.getElementById("admin-image-file").value = "";
      document.getElementById("admin-image-preview").style.display = "none";
      showModal("Question and image uploaded.");
    };
    reader.readAsDataURL(file);
  } else {
    db.ref("games/" + gameID).update({ question, image: "" });
    document.getElementById("admin-question-input").value = "";
    showModal("Question uploaded.");
  }
}
function resetBuzzers() {
  db.ref(`games/${gameID}/players`).once("value").then(snap => {
    const players = snap.val() || {};
    Object.keys(players).forEach(pid => {
      db.ref(`games/${gameID}/players/${pid}`).update({ buzzed: false });
    });
  });
  db.ref(`games/${gameID}`).update({ buzzed: "", lock: false });
  updateUnlockButton();
}
function lockBuzzers() {
  db.ref(`games/${gameID}`).update({ lock: true });
  updateUnlockButton();
}
function unlockBuzzers() {
  db.ref(`games/${gameID}`).update({ lock: false, buzzed: "" });
  updateUnlockButton();
}
function updateUnlockButton() {
  db.ref(`games/${gameID}/lock`).once("value").then(snap => {
    const locked = snap.val();
    const btn = document.getElementById("unlock-buzzer-btn");
    btn.style.display = locked ? "inline-block" : "none";
  });
}
function nextRound() {
  db.ref(`games/${gameID}`).once("value").then(snap => {
    const round = (snap.val().round || 1) + 1;
    db.ref(`games/${gameID}`).update({ round: round, buzzed: "", lock: false });
    resetBuzzers();
  });
}
function clearAllScores() {
  db.ref("games").remove();
  showModal("All scores cleared.");
}
// User management: Load users and roles
function readAdminUserlist() {
  db.ref("users").once("value").then(snap => {
    let html = `<table><thead><tr><th>Avatar</th><th>Username</th><th>Email</th><th>Role</th></tr></thead><tbody>`;
    snap.forEach(u => {
      const data = u.val();
      html += `<tr>
        <td class="avatar-column">${data.avatar ? `<img src="${data.avatar}">` : ""}</td>
        <td style="color:#ffe05b;">${u.key}</td>
        <td>${data.email || ""}</td>
        <td>
          <select class="role-dropdown" onchange="changeUserRole('${u.key}', this.value)">
            <option value="user" ${data.role === "user" ? "selected" : ""}>User</option>
            <option value="admin" ${data.role === "admin" ? "selected" : ""}>Admin</option>
          </select>
        </td>
      </tr>`;
    });
    html += "</tbody></table>";
    document.getElementById("admin-userlist").innerHTML = html;
  });
}
window.changeUserRole = function (username, role) {
  db.ref("users/" + username).update({ role: role }).then(() => {
    showModal("Role updated for " + username);
    readAdminUserlist();
    if (username === myUser) showHome();
  });
};
// Admin panel scores and status
function readAdmin() {
  db.ref(`games/${gameID}`).on("value", snap => {
    const g = snap.val() || {};
    document.getElementById("round-label").textContent = g.round || 1;
    document.getElementById("question-text").textContent = g.question || "";
    const img = document.getElementById("question-img");
    if (g.image) { img.src = g.image; img.style.display = "block"; } else { img.style.display = "none"; }
    const players = g.players || {};
    const arr = Object.entries(players);
    let html = `<table><thead><tr><th>Avatar</th><th>Name</th><th>Team</th><th>Score</th><th>Status</th></tr></thead><tbody>`;
    arr.forEach(([id, pl]) => {
      html += `<tr><td class='avatar-column'>${pl.avatar ? `<img src='${pl.avatar}'/>` : ""}</td><td>${pl.name}</td><td>${pl.team || ""}</td><td>${pl.score || 0}</td><td>${id === g.buzzed ? '<span class="buzzed-tag">Buzzed</span>' : ""}</td></tr>`;
    });
    html += "</tbody></table>";
    document.getElementById("admin-scores").innerHTML = html;
    document.getElementById("buzzed-who").textContent = g.buzzed && g.players && g.players[g.buzzed] ? `üîî ${g.players[g.buzzed].name}` : "";
    updateUnlockButton();
  });
}
function listenAdmin() {
  readAdmin();
  readAdminUserlist();
}
// Join game and add player
function joinGame() {
  const code = document.getElementById("join-code").value.trim();
  const team = document.getElementById("join-team").value.trim();
  if (!code) return showModal("Enter 6-digit game code");
  if (!myUser) return showModal("Please login first");
  gameID = code;
  myTeam = team;
  myPID = btoa(myUser + Math.random()).replace(/=/g, "");
  db.ref(`users/${myUser}`).get().then(userSnap => {
    const avatar = (userSnap.val() && userSnap.val().avatar) || "";
    db.ref(`games/${code}/players/${myPID}`).set({ name: myUser, team, score: 0, buzzed: false, joined: Date.now(), avatar }).then(() => {
      db.ref(`games/${code}/players/${myPID}`).onDisconnect().remove();
      showPage("page-player");
      listenPlayer();
      listenQuestionPlayer();
    });
  });
}
// Player listen and buzzer control
function listenPlayer() {
  db.ref(`games/${gameID}`).on("value", snap => {
    const g = snap.val() || {};
    document.getElementById("buzz-lock-msg").textContent = g.lock ? "Buzzers are locked!" : (g.buzzed ? "Buzzer locked!" : "");
    const players = g.players || {};
    let html = "";
    Object.entries(players).forEach(([id, pl]) => {
      html += `<div>${pl.name}${pl.team ? ` (${pl.team})` : ""} ${id === g.buzzed ? '<span class="buzzed-tag">Buzzed</span>' : ''}</div>`;
    });
    document.getElementById("player-scores").innerHTML = html;
    const playerBtn = document.getElementById("player-buzzer");
    playerBtn.disabled = g.buzzed && g.buzzed !== myPID || g.lock;
    if (g.buzzed && !buzzLockSoundPlayed) {
      document.getElementById("buzz-audio").currentTime = 0;
      document.getElementById("buzz-audio").play();
      buzzLockSoundPlayed = true;
    }
    if (!g.buzzed) buzzLockSoundPlayed = false;
  });
}
// Player question and image listen
function listenQuestionPlayer() {
  db.ref(`games/${gameID}`).on("value", snap => {
    const g = snap.val() || {};
    document.getElementById("player-question-text").textContent = g.question || "";
    const img = document.getElementById("player-question-img");
    if (g.image) { img.src = g.image; img.style.display = "block"; } else { img.style.display = "none"; }
  });
}
// Buzzing function
function buzz() {
  db.ref(`games/${gameID}`).get().then(snap => {
    const g = snap.val();
    if (!g || g.buzzed || g.lock) return showModal("Buzzer is locked!");
    db.ref(`games/${gameID}`).update({ buzzed: myPID });
    db.ref(`games/${gameID}/players/${myPID}`).update({ buzzed: true });
  });
}
document.addEventListener("keydown", e => {
  if (e.code === "Space") {
    e.preventDefault();
    const btn = document.getElementById("player-buzzer");
    if (btn && !btn.disabled) buzz();
  }
});
// Display the global scoreboard
function showScoreboard() {
  showPage("page-scoreboard");
  db.ref("games").once("value").then(snap => {
    const games = snap.val() || {};
    let totalScores = {};
    for (const gid in games) {
      const players = games[gid].players || {};
      for (const pid in players) {
        let name = players[pid].name || "Unknown";
        totalScores[name] = (totalScores[name] || 0) + (players[pid].score || 0);
      }
    }
    const sorted = Object.entries(totalScores).sort((a, b) => b[1] - a[1]);
    let html = `<thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead><tbody>`;
    if (sorted.length === 0) html += `<tr><td colspan="3">No scores yet</td></tr>`;
    sorted.forEach(([name, score], i) => {
      html += `<tr><td>${i + 1}</td><td>${name}</td><td>${score}</td></tr>`;
    });
    html += "</tbody>";
    document.getElementById("scoreboard-table").innerHTML = html;
  });
}
</script>
</body>
</html>
