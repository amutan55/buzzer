<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {
    margin: 0; padding: 0; height: 100%; font-family: 'Montserrat', Arial, sans-serif;
    background: var(--main-bg); color: #fff; user-select: none;
  }
  .page {
    display: none; max-width: 720px; margin: 0 auto; padding: 28px 32px;
  }
  .show {
    display: block;
  }
  h1, h2, h3 {
    font-weight: 700; margin-bottom: 24px; text-align: center;
  }
  input[type=text], input[type=password], input[type=email], input[type=file] {
    width: 100%; max-width: 420px; padding: 14px 18px; font-size: 1.2em;
    border-radius: var(--radius); border: none; margin: 12px auto 24px auto;
    background: #344365; color: #fff; box-sizing: border-box; text-align: center;
  }
  input::placeholder { color: #bac3e6; }
  button {
    background: var(--primary);
    color: #fff;
    font-family: Montserrat; font-weight: 700; font-size: 1.3em;
    border: none; border-radius: 48px; padding: 18px 20px;
    cursor: pointer;
    box-shadow: 0 6px 13px #2554a180;
    user-select: none;
    transition: background 0.2s ease;
    text-align: center;
    min-width: 180px;
    max-width: 320px;
    margin: 18px auto;
    display: block;
  }
  button:hover:not(:disabled) { background: var(--accent); color: #232323; }
  button:disabled { background: #ddd; color: #999; cursor: not-allowed; box-shadow: none; }
  label { color: #acbede; font-size: 1.05em; margin-bottom: 6px; display: block; user-select: none; }
  .buzzer-btn {
    background: var(--accent); color: #141c34;
    font-size: 5rem; font-weight: 900;
    padding: 72px 180px; border-radius: 160px;
    border: 12px solid #fff;
    box-shadow: 0 14px 64px #ffea6fcc;
    cursor: pointer;
    user-select: none;
    max-width: 90vw;
    display: block;
    margin: 48px auto 56px auto;
    text-align: center;
  }
  .buzzer-btn:disabled {
    background: #eee; color: #888; border-color: #ccc; cursor: not-allowed; box-shadow: none;
  }
  .scoreboard {
    max-width: 720px; margin: 30px auto;
    background: #222947; padding: 18px 28px;
    box-shadow: 0 2px 14px #0008; border-radius: 20px;
    color: #fff;
    overflow-x: auto;
  }
  table {
    width: 100%; border-collapse: collapse; color: #fff;
  }
  thead tr { background: var(--primary); }
  th, td {
    padding: 14px 10px; border: 1px solid #1a2138; text-align: center;
  }
  tbody tr:nth-child(odd) { background: #2a2f4b; }
  tbody tr:hover { background-color: #3b8bee90; }
  .avatar-column img {
    width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
  }
  .buzzed-tag {
    background: var(--accent);
    color: #232323;
    border-radius: 14px;
    padding: 6px 14px;
    font-size: 1.1em;
    user-select: none;
    font-weight: 700;
  }
  #buzz-lock-msg, #buzzed-who {
    color: var(--accent);
    font-weight: 700;
    text-align: center;
    user-select: none;
  }
  #buzz-lock-msg { margin-top: 15px; font-size: 1.3em; }
  #buzzed-who { font-size: 1.8em; margin: 30px 0 24px 0; }
  #question-text, #player-question-text {
    font-size: 2.9em;
    font-weight: 900;
    margin: 30px auto 24px auto;
    max-width: 90vw;
    word-break: break-word;
    text-align: center;
  }
  #question-img, #player-question-img {
    max-width: 90vw;
    max-height: 400px;
    border-radius: 24px;
    margin: 0 auto 30px auto;
    display: block;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
    z-index: 1;
  }
  #question-img.zoomed, #player-question-img.zoomed {
    transform: scale(2);
    cursor: zoom-out;
    position: relative;
    z-index: 9999;
    box-shadow: 0 0 20px #ffea6fcc;
  }
  .backbtn {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.3em;
    padding: 12px 40px;
    border-radius: 44px;
    background: #364063;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 5px 16px #000a;
    user-select: none;
    z-index: 1100;
    transition: background 0.3s ease;
  }
  .backbtn:hover {
    background: var(--accent);
    color: #232323;
  }
  .center-box {
    max-width: 720px;
    margin: 0 auto;
    padding: 30px 24px;
    background: #2b3250;
    border-radius: 24px;
    box-shadow: 0 4px 38px #232f66bb;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .avatar-preview {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    margin-bottom: 22px;
    object-fit: cover;
    box-shadow: 0 0 12px #12183fbb;
  }
</style>
</head>
<body>

<button class="backbtn" id="backbtn" style="display:none" onclick="backButtonHandler()">‚Üê Back</button>
<div id="modal" style="position:fixed; top:20px; left:50%; transform:translateX(-50%);
  padding:18px 32px; background:#ffcf46cc; border-radius:16px; color:#232323;
  font-weight:700; display:none; user-select:none; z-index:9999;"></div>

<!-- Pages Start -->
<div id="page-login" class="page show">
  <div class="center-box">
    <h1>Login</h1>
    <input type="text" id="login-username" placeholder="Username" maxlength="24" autocomplete="off"/>
    <input type="password" id="login-password" placeholder="Password" maxlength="24"/>
    <button onclick="loginUser()">Login</button>
    <button onclick="showRegister()">Register</button>
  </div>
</div>

<div id="page-register" class="page">
  <div class="center-box">
    <h1>Register</h1>
    <input type="text" id="register-username" placeholder="Username" maxlength="24" autocomplete="off"/>
    <input type="password" id="register-password" placeholder="Password" maxlength="24"/>
    <input type="email" id="register-email" placeholder="Email"/>
    <input type="file" id="register-avatar" accept="image/*"/>
    <img id="register-avatar-preview" class="avatar-preview" style="display:none;"/>
    <button onclick="registerUser()">Register</button>
    <button onclick="showLogin()">Back</button>
  </div>
</div>

<div id="page-home" class="page">
  <div class="center-box">
    <h2>Welcome, <span id="welcome-user"></span>!</h2>
    <button onclick="hostPage()">Host Game</button>
    <button onclick="joinPage()">Join Game</button>
    <button onclick="showProfile()">Profile</button>
    <button id="adminPanelBtn" onclick="adminPanel()" style="display:none;">Admin Panel</button>
    <button onclick="showScoreboard()">Scoreboard</button>
  </div>
</div>

<div id="page-profile" class="page">
  <div class="center-box">
    <h2>Your Profile</h2>
    <img id="profile-avatar-preview" class="avatar-preview" style="display:none;"/>
    <input type="text" id="profile-nickname" placeholder="Nickname" maxlength="24" readonly/>
    <input type="password" id="profile-password" placeholder="New Password" maxlength="24" />
    <input type="email" id="profile-email" placeholder="Email" />
    <input type="file" id="profile-avatar" accept="image/*" />
    <button onclick="updateProfile()">Save Changes</button>
  </div>
</div>

<div id="page-users" class="page">
  <div class="center-box">
    <h2>User Management <span style="color:#ffe05b">(Admin)</span></h2>
    <table>
      <thead><tr><th>Avatar</th><th>Username</th><th>Email</th><th>Role</th><th>Delete</th></tr></thead>
      <tbody id="userlist"></tbody>
    </table>
    <input type="text" id="create-username" placeholder="New Username"/>
    <input type="password" id="create-password" placeholder="New Password"/>
    <input type="email" id="create-email" placeholder="Email"/>
    <input type="file" id="create-avatar" accept="image/*"/>
    <img id="create-avatar-preview" class="avatar-preview" style="display:none;"/>
    <button onclick="createUser()">Create User</button>
  </div>
</div>

<div id="page-host" class="page">
  <div class="center-box">
    <h2>Host Game</h2>
    <label>Game Code:</label><br/>
    <input type="text" id="host-code" readonly/><br/>
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<div id="page-admin-panel" class="page">
  <div class="center-box">
    <h2>Admin Control</h2>
    <div><b>Game Code:</b> <span id="roomcode"></span></div>
    <div><b>Round:</b> <span id="round-label"></span></div>
    <div id="question-holder">
      <div id="question-text"></div>
      <img id="question-img" alt="Question Image" />
    </div>
    <input type="text" id="admin-question-input" placeholder="Enter question here" /><br/>
    <input type="file" id="admin-image-file" accept="image/*" /><br/>
    <img id="admin-image-preview" style="display:none; max-width: 100%; max-height: 250px; margin-bottom: 14px;" />
    <button onclick="uploadQuestion()">Upload Question</button>
    <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 18px;">
      <button onclick="resetBuzzers()">Reset Buzzer</button>
      <button onclick="resetRound()">Reset Round</button>
      <button onclick="nextRound()">Next Round</button>
      <button onclick="clearAllScores()">Clear All Scores</button>
    </div>
    <table id="admin-scores" style="width: 100%; background: #222947; color:#fff; border-radius: 14px; margin-top: 18px;"></table>
    <div id="buzzed-who" style="margin-top: 22px;"></div>
  </div>
</div>

<div id="page-join" class="page">
  <div class="center-box">
    <h2>Join Game</h2>
    <input type="text" id="join-code" maxlength="6" placeholder="Game Code" autocomplete="off" />
    <input type="text" id="join-team" maxlength="24" placeholder="Team Name (optional)" />
    <button onclick="joinGame()">Join</button>
  </div>
</div>

<div id="page-player" class="page">
  <div class="center-box">
    <h2>Quiz Buzzer</h2>
    <img id="player-avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 18px; display:none;" />
    <div style="color: #ffe05b; font-weight: 700; font-size: 1.4em; margin-bottom: 10px;">
      Hello, <span id="pl-name"></span>!
    </div>
    <div><b>Game Code:</b> <span id="pl-room"></span></div>
    <div><b>Team:</b> <span id="pl-team"></span></div>
    <div id="player-question-text" style="font-size: 2.5em; font-weight: 700; margin: 30px 0 15px 0; max-width: 90vw; text-align: center;"></div>
    <img id="player-question-img" src="" alt="Player Question Image" style="display:none; max-width: 90vw; max-height: 350px; border-radius: 20px; margin-bottom: 25px; cursor: zoom-in; transition: transform 0.3s ease;" />
    <button id="player-buzzer" class="buzzer-btn" onclick="buzz()">BUZZ!</button>
    <div id="buzz-lock-msg"></div>
    <div class="scoreboard" id="player-scores"></div>
  </div>
</div>

<div id="page-scoreboard" class="page">
  <div class="center-box">
    <h2>Overall Scoreboard</h2>
    <table id="scoreboard-table" style="width: 100%; background: #222947; color: #fff; border-radius: 14px;"></table>
  </div>
</div>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>

<script>
  // Firebase initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
    authDomain: "buzzer-a0d53.firebaseapp.com",
    databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "buzzer-a0d53",
    storageBucket: "buzzer-a0d53.appspot.com",
    messagingSenderId: "29031182202",
    appId: "1:29031182202:web:447d951b38be59b29270c3",
    measurementId: "G-NP0DMX7TKJ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let gameID = "", myRole = "", myUser = "", myTeam = "", myPID = "", buzzLockSoundPlayed = false;
  let pageHistory = [];

  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("show"));
    document.getElementById(id).classList.add("show");
    document.getElementById("backbtn").style.display = id === "page-login" ? "none" : "inline-block";
  }
  function backButtonHandler() {
    if (pageHistory.length > 1) {
      pageHistory.pop();
      showPage(pageHistory[pageHistory.length - 1]);
    }
  }
  function navigateToPage(id) {
    if (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== id) {
      pageHistory.push(id);
    }
    showPage(id);
  }
  function showRegister() { navigateToPage("page-register"); }
  function showLogin() { navigateToPage("page-login"); }
  function showHome() {
    document.getElementById("welcome-user").textContent = myUser;
    document.getElementById("adminPanelBtn").style.display = myUser === "admin" ? "inline-block" : "none";
    navigateToPage("page-home");
  }
  function showProfile() {
    db.ref("users/" + myUser).get().then(snap => {
      const user = snap.val();
      const avatarPreview = document.getElementById("profile-avatar-preview");
      if (user && user.avatar) {
        avatarPreview.src = user.avatar;
        avatarPreview.style.display = "block";
      } else {
        avatarPreview.style.display = "none";
      }
      document.getElementById("profile-nickname").value = myUser;
      document.getElementById("profile-password").value = "";
      document.getElementById("profile-email").value = (user && user.email) || "";
      navigateToPage("page-profile");
    });
  }
  function showModal(msg, t = 1800) {
    const modal = document.getElementById("modal");
    modal.textContent = msg;
    modal.style.display = "block";
    setTimeout(() => modal.style.display = "none", t);
  }

  // Avatar preview handlers
  ["register-avatar", "profile-avatar", "create-avatar", "admin-image-file"].forEach(id => {
    document.getElementById(id).addEventListener("change", e => {
      const file = e.target.files[0];
      const previewId = id === "admin-image-file" ? "admin-image-preview" : id + "-preview";
      const preview = document.getElementById(previewId);
      if (!file) {
        preview.style.display = "none";
        preview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
  });

  // Registration function
  function registerUser() {
    const username = document.getElementById("register-username").value.trim();
    const pw = document.getElementById("register-password").value.trim();
    const email = document.getElementById("register-email").value.trim();
    const avatarFile = document.getElementById("register-avatar").files[0];
    if (!username || !pw || !email) return showModal("All fields are required.");
    if (username.toLowerCase() === "admin") return showModal("Username 'admin' reserved.");
    db.ref("users/" + username).get().then(snap => {
      if (snap.exists()) return showModal("Username already exists.");
      if (avatarFile) {
        const reader = new FileReader();
        reader.onload = e => {
          db.ref("users/" + username).set({ pw, email, role: "user", avatar: e.target.result }).then(() => {
            showModal("Registered! Please login.", 1400);
            setTimeout(showLogin, 1300);
          });
        };
        reader.readAsDataURL(avatarFile);
      } else {
        db.ref("users/" + username).set({ pw, email, role: "user", avatar: "" }).then(() => {
          showModal("Registered! Please login.", 1400);
          setTimeout(showLogin, 1300);
        });
      }
    });
  }

  // Login function
  function loginUser() {
    const username = document.getElementById("login-username").value.trim();
    const pw = document.getElementById("login-password").value.trim();
    if (!username || !pw) return showModal("Fill username and password.");
    if (username.toLowerCase() === "admin" && pw === "24207") {
      myUser = "admin";
      showHome();
      return;
    }
    db.ref("users/" + username).get().then(snap => {
      if (!snap.exists()) return showModal("User not found.");
      const user = snap.val();
      if (user.pw !== pw) return showModal("Incorrect password.");
      myUser = username;
      showHome();
    });
  }

  // Profile update
  function updateProfile() {
    const password = document.getElementById("profile-password").value.trim();
    const email = document.getElementById("profile-email").value.trim();
    const avatarFile = document.getElementById("profile-avatar").files[0];
    const updateObj = {};
    if (password) updateObj.pw = password;
    if (email) updateObj.email = email;
    if (avatarFile) {
      const reader = new FileReader();
      reader.onload = e => {
        updateObj.avatar = e.target.result;
        db.ref("users/" + myUser).update(updateObj).then(() => {
          showModal("Profile updated.", 1300);
          showHome();
        });
      };
      reader.readAsDataURL(avatarFile);
    } else {
      db.ref("users/" + myUser).update(updateObj).then(() => {
        showModal("Profile updated.", 1300);
        showHome();
      });
    }
  }

  // Admin user management
  function adminPanel() {
    if (myUser !== "admin") return;
    reloadUsers();
    navigateToPage("page-users");
  }
  function reloadUsers() {
    db.ref("users").get().then(snap => {
      let html = "";
      snap.forEach(u => {
        const data = u.val();
        html += `<tr>
          <td class="avatar-column">${data.avatar ? `<img src="${data.avatar}">` : ""}</td>
          <td style="color:#ffe05b;">${u.key}</td>
          <td>${data.email || ""}</td>
          <td>${data.role || "user"}</td>
          <td>${u.key !== "admin" ? `<button onclick="deleteUser('${u.key}')">Delete</button>` : ""}</td>
        </tr>`;
      });
      document.getElementById("userlist").innerHTML = html;
    });
  }
  function createUser() {
    const username = document.getElementById("create-username").value.trim();
    const pw = document.getElementById("create-password").value.trim();
    const email = document.getElementById("create-email").value.trim();
    const avatarFile = document.getElementById("create-avatar").files[0];
    if (!username || !pw || !email) return showModal("Fill all fields.");
    db.ref("users/" + username).get().then(snap => {
      if (snap.exists()) return showModal("User exists.");
      if (avatarFile) {
        const reader = new FileReader();
        reader.onload = e => {
          db.ref("users/" + username).set({ pw, email, role: "user", avatar: e.target.result }).then(() => {
            showModal("User created.", 1300);
            reloadUsers();
          });
        };
        reader.readAsDataURL(avatarFile);
      } else {
        db.ref("users/" + username).set({ pw, email, role: "user", avatar: "" }).then(() => {
          showModal("User created.", 1300);
          reloadUsers();
        });
      }
    });
  }
  function deleteUser(username) {
    if (username === "admin") return;
    db.ref("users/" + username).remove().then(reloadUsers);
  }

  // Host a game
  function hostPage() {
    navigateToPage("page-host");
    const code = String(Math.floor(Math.random() * 900000 + 100000));
    document.getElementById("host-code").value = code;
    gameID = code;
    db.ref("games/" + code).set({
      created: Date.now(),
      status: "waiting",
      round: 1,
      question: "",
      image: "",
      players: {},
      buzzed: "",
      totalScores: {}
    });
    myRole = "admin";
  }
  function startGame() {
    db.ref("games/" + gameID).update({ status: "live", round: 1 });
    navigateToPage("page-admin-panel");
    document.getElementById("roomcode").textContent = gameID;
    readAdmin();
    listenQuestionAdmin();
  }

  // Upload question
  function uploadQuestion() {
    const question = document.getElementById("admin-question-input").value.trim();
    const imgInput = document.getElementById("admin-image-file");
    const imgFile = imgInput.files[0];
    if (!question) return showModal("Please enter a question.");
    if (imgFile) {
      const reader = new FileReader();
      reader.onload = e => {
        db.ref("games/" + gameID).update({ question, image: e.target.result });
        imgInput.value = "";
        document.getElementById("admin-image-preview").style.display = "none";
        document.getElementById("admin-question-input").value = "";
        showModal("Question and Image uploaded.", 1400);
      };
      reader.readAsDataURL(imgFile);
    } else {
      db.ref("games/" + gameID).update({ question, image: "" });
      document.getElementById("admin-question-input").value = "";
      showModal("Question uploaded.", 1200);
    }
  }

  // Reset and next round functions
  function resetBuzzers() {
    db.ref(`games/${gameID}/players`).once("value").then(snap => {
      const players = snap.val() || {};
      Object.keys(players).forEach(pid => {
        db.ref(`games/${gameID}/players/${pid}`).update({ buzzed: false });
      });
    });
    db.ref(`games/${gameID}`).update({ buzzed: "" });
    buzzLockSoundPlayed = false;
  }
  function resetRound() {
    db.ref(`games/${gameID}/players`).once("value").then(snap => {
      const players = snap.val() || {};
      Object.keys(players).forEach(pid => {
        db.ref(`games/${gameID}/players/${pid}`).update({ buzzed: false, score: 0 });
      });
    });
    db.ref(`games/${gameID}`).update({ buzzed: "" });
    buzzLockSoundPlayed = false;
  }
  function nextRound() {
    db.ref(`games/${gameID}`).once("value", snap => {
      let r = (snap.val() && snap.val().round) || 1;
      db.ref(`games/${gameID}`).update({ round: r + 1, buzzed: "" });
      resetRound();
    });
  }

  // Admin score adjustment
  function adminScore(delta, pid) {
    db.ref(`games/${gameID}/players/${pid}`).once("value").then(s => {
      let v = s.val();
      const newScore = (v.score || 0) + delta;
      db.ref(`games/${gameID}/players/${pid}`).update({ score: newScore });
      updateTotalScore(pid, delta);
    });
  }

  // Update total accumulated score for player over all games
  function updateTotalScore(pid, deltaScore) {
    db.ref(`games/${gameID}/totalScores/${pid}`).once('value').then(snap => {
      let currentTotal = (snap.val() || 0) + deltaScore;
      db.ref(`games/${gameID}/totalScores/${pid}`).set(currentTotal);
    });
  }

  // Clear all scores (admin only)
  function clearAllScores() {
    if (myUser !== "admin") {
      showModal("Only admin can clear scores.");
      return;
    }
    db.ref('games').once('value').then(snap => {
      const games = snap.val() || {};
      Object.entries(games).forEach(([gid, game]) => {
        if(game.players){
          Object.keys(game.players).forEach(pid => {
            db.ref(`games/${gid}/players/${pid}`).update({ score: 0, buzzed: false });
          });
        }
        db.ref(`games/${gid}`).update({ buzzed: "" });
        db.ref(`games/${gid}/totalScores`).remove();
      });
      showModal("All scores cleared.");
      if(gameID) readAdmin();
    });
  }

  // Admin panel scoreboard
  function readAdmin() {
    db.ref(`games/${gameID}`).on("value", snap => {
      const g = snap.val() || {};
      document.getElementById("round-label").textContent = g.round || 1;
      document.getElementById("question-text").textContent = g.question || "";
      const imgTag = document.getElementById("question-img");
      if (g.image) {
        imgTag.src = g.image;
        imgTag.style.display = "block";
      } else {
        imgTag.style.display = "none";
      }
      const players = g.players || {};
      let arr = Object.entries(players).map(([id, v]) => ({ ...v, id }));
      arr.sort((a, b) => (b.score || 0) - (a.score || 0));
      const buzzedID = g.buzzed;
      const buzzedPlayer = arr.find(x => x.id === buzzedID);
      let who = buzzedPlayer ? `<span class="buzzed-tag">üîî ${buzzedPlayer.name}</span>` : "";
      document.getElementById("buzzed-who").innerHTML = who;
      let html = `<thead><tr><th>Rank</th><th>Avatar</th><th>Player</th><th>Score</th><th>Actions</th><th>Status</th></tr></thead><tbody>`;
      arr.forEach((pl, i) => {
        html += `<tr>
          <td>${i + 1}</td>
          <td><img src="${pl.avatar || ''}" alt="avatar" style="width:40px; height:40px; border-radius:50%; object-fit:cover;"></td>
          <td style="color:#ffe05b; font-weight:700;">${pl.name}${pl.team ? ' (' + pl.team + ')' : ''}</td>
          <td>${pl.score || 0}</td>
          <td>
            <button onclick="adminScore(25,'${pl.id}')">+25</button>
            <button onclick="adminScore(-25,'${pl.id}')">-25</button>
          </td>
          <td>${pl.id === buzzedID ? '<span class="buzzed-tag">Buzzed</span>' : ''}</td>
          </tr>`;
      });
      html += "</tbody>";
      document.getElementById("admin-scores").innerHTML = html || "<tbody><tr><td colspan='6'>No players yet</td></tr></tbody>";
    });
  }

  // Listen question changes for admin
  function listenQuestionAdmin() {
    db.ref(`games/${gameID}`).on("value", snap => {
      const g = snap.val() || {};
      document.getElementById("question-text").textContent = g.question || "";
      const imgTag = document.getElementById("question-img");
      if (g.image) {
        imgTag.src = g.image;
        imgTag.style.display = "block";
      } else {
        imgTag.style.display = "none";
      }
    });
  }

  // Join game page
  function joinPage() {
    navigateToPage("page-join");
  }

  // Join game logic
  function joinGame() {
    const code = document.getElementById("join-code").value.trim();
    const team = document.getElementById("join-team").value.trim();
    if (!/^\d{6}$/.test(code)) return showModal("Enter 6 digit game code", 1600);
    if (!myUser) return showModal("Please login first", 1600);
    gameID = code;
    myTeam = team;
    myRole = "player";
    const myid = btoa(myUser + Math.random()).replace(/=/g, "");
    myPID = myid;
    db.ref(`games/${code}`).get().then(snap => {
      if (!snap.exists()) return showModal("Game not found", 1400);
      db.ref(`users/${myUser}`).get().then(userSnap => {
        const avatar = (userSnap.val() && userSnap.val().avatar) || "";
        db.ref(`games/${code}/players/${myid}`).set({
          name: myUser,
          team,
          score: 0,
          buzzed: false,
          joined: Date.now(),
          avatar
        }).then(() => {
          document.getElementById("pl-name").textContent = myUser;
          const avatarPreview = document.getElementById("player-avatar-preview");
          if (avatar) {
            avatarPreview.src = avatar;
            avatarPreview.style.display = "block";
          } else {
            avatarPreview.style.display = "none";
          }
          document.getElementById("pl-room").textContent = code;
          document.getElementById("pl-team").textContent = team || "(no team)";
          navigateToPage("page-player");
          listenPlayer();
          listenQuestionPlayer();
        });
      });
    });
  }

  // Player buzz listening
  function listenPlayer() {
    db.ref(`games/${gameID}`).on("value", snap => {
      const g = snap.val() || {};
      document.getElementById("buzz-lock-msg").textContent = g.buzzed ? "Buzzer is locked!" : "";
      const players = g.players || {};
      let arr = Object.entries(players).map(([id, v]) => ({ ...v, id }));
      arr.sort((a, b) => (b.score || 0) - (a.score || 0));
      const buzzedID = g.buzzed;
      let html = "";
      arr.forEach((pl, i) => {
        html += `<div class="score-row">
          <span class="rank">${i + 1}</span>
          <span class="pname" style="color:#ffe05b;">${pl.name}${pl.team ? ' (' + pl.team + ')' : ''}</span>
          <span class="pscore">${pl.score || 0}</span>
          ${pl.id === buzzedID ? '<span class="buzzed-tag">Buzzed</span>' : ""}
          </div>`;
      });
      document.getElementById("player-scores").innerHTML = html || "(no players yet)";
      const playerBtn = document.getElementById("player-buzzer");
      playerBtn.disabled = buzzedID && buzzedID !== myPID;
      if (buzzedID && !buzzLockSoundPlayed) {
        const audio = document.getElementById("buzz-audio");
        audio.currentTime = 0;
        audio.play();
        buzzLockSoundPlayed = true;
      }
      if (!buzzedID) buzzLockSoundPlayed = false;
    });
  }

  // Player question listening
  function listenQuestionPlayer() {
    db.ref(`games/${gameID}`).on("value", snap => {
      const g = snap.val() || {};
      document.getElementById("player-question-text").textContent = g.question || "";
      const imgTag = document.getElementById("player-question-img");
      if (g.image) {
        imgTag.src = g.image;
        imgTag.style.display = "block";
      } else {
        imgTag.style.display = "none";
      }
    });
  }

  // Buzz function
  function buzz() {
    db.ref(`games/${gameID}`).get().then(snap => {
      const g = snap.val();
      if (!g || g.buzzed) return showModal("Buzzer is locked!", 1200);
      db.ref(`games/${gameID}/players/${myPID}`).update({ buzzed: true });
      db.ref(`games/${gameID}`).update({ buzzed: myPID });
    });
  }

  // Scoreboard page showing totals over all games
  function showScoreboard() {
    navigateToPage("page-scoreboard");
    db.ref("games").once("value").then(snap => {
      const games = snap.val() || {};
      let totalScores = {};
      for (const gid in games) {
        const game = games[gid];
        if (!game.totalScores) continue;
        for (const pid in game.totalScores) {
          totalScores[pid] = (totalScores[pid] || 0) + game.totalScores[pid];
        }
      }
      const sorted = Object.entries(totalScores).sort((a,b) => b[1]-a[1]);
      let html = `<thead><tr><th>Rank</th><th>Player</th><th>Total Points</th></tr></thead><tbody>`;
      if(sorted.length === 0){
        html += `<tr><td colspan="3">No scores yet</td></tr>`;
        document.getElementById('scoreboard-table').innerHTML = html + "</tbody>";
        return;
      }
      let fetchNames = [];
      sorted.forEach(([pid],i) => {
        // fetch player name from any game
        fetchNames.push(db.ref("games").orderByChild(`players/${pid}/name`).once("value").then(snap => {
          const gamesVal = snap.val() || {};
          for(const gameKey in gamesVal){
            const p = gamesVal[gameKey].players && gamesVal[gameKey].players[pid];
            if(p && p.name) {
              sorted[i].push(p.name);
              return; // found name, stop
            }
          }
          sorted[i].push("Unknown");
        }));
      });
      Promise.all(fetchNames).then(() => {
        sorted.forEach(([pid, score, name], i) => {
          html += `<tr><td>${i+1}</td><td style="color:#ffe05b;">${name}</td><td>${score}</td></tr>`;
        });
        html += "</tbody>";
        document.getElementById('scoreboard-table').innerHTML = html;
      });
    });
  }

  // Zoom images on click
  [document.getElementById("question-img"), document.getElementById("player-question-img")]
    .forEach(img => {
      img.addEventListener("click", () => {
        if(img.style.display==="none") return;
        img.classList.toggle("zoomed");
      });
    });

  // Add your remaining functions for registerUser, loginUser, createUser, deleteUser,
  // hostPage, startGame, resetBuzzers, resetRound, nextRound, adminScore, readAdmin,
  // listenQuestionAdmin, etc. from previous messages exactly.

</script>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>

</body>
</html>

