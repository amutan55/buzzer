<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro - Multi Page SPA</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
    --btn-bg: var(--primary);
    --btn-hover-bg: var(--accent);
  }

  html, body {
    margin:0; padding:0; min-height:100vh; font-family: 'Montserrat', Arial, sans-serif;
    background: var(--main-bg); color: #fff;
  }
  a {
    text-decoration: none; color: var(--btn-bg); font-weight: 700; cursor: pointer;
    display: inline-block; padding: 10px 22px; border-radius: 32px;
    border: 2px solid var(--btn-bg); background-color: transparent;
    transition: all .3s ease;
    margin: 0 8px;
  }
  a:hover {
    color: var(--main-bg);
    background-color: var(--btn-hover-bg);
    border-color: var(--btn-hover-bg);
  }
  header {
    background: #232a55;
    padding: 12px 24px;
    box-shadow: 0 4px 12px #0006;
    position: sticky;
    top: 0;
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    font-weight: 900;
    font-size: 1.6rem;
    margin: 0;
    color: var(--accent);
  }
  nav a {
    font-size: 1.1rem;
  }
  main {
    padding: 24px;
    max-width: 720px;
    margin: 0 auto;
  }
  h2 {
    font-weight: 700;
    margin-bottom: 18px;
  }
  input[type=text], input[type=password], input[type=email], input[type=number], input[type=file] {
    width: 100%; max-width: 400px;
    padding: 12px 16px;
    margin-bottom: 20px;
    font-size: 1.1rem;
    border-radius: var(--radius);
    border: none;
    background: #344365;
    color: #fff;
    box-sizing: border-box;
  }
  button {
    background: var(--btn-bg);
    border: none;
    border-radius: 48px;
    color: #fff;
    font-size: 1.2rem;
    font-weight: 700;
    padding: 14px 28px;
    cursor: pointer;
    box-shadow: 0 6px 12px #2554a1aa;
    transition: background .25s ease;
  }
  button:hover {
    background: var(--btn-hover-bg);
    color: #232323;
  }
  .buzzer-btn {
    font-size: 3.5rem;
    font-weight: 900;
    padding: 48px 100px;
    border-radius: 90px;
    border: 8px solid #fff;
    background: var(--accent);
    color: #141c34;
    box-shadow: 0 10px 30px #ffea6fcc;
    user-select: none;
  }
  .buzzer-btn:disabled {
    background: #ddd;
    color: #888;
    border-color: #ccc;
    cursor: not-allowed;
    box-shadow: none;
  }
  .scoreboard {
    background-color: #222947;
    padding: 16px;
    border-radius: 20px;
    color: #fff;
    max-height: 380px;
    overflow-y: auto;
    box-shadow: 0 3px 22px #0008;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    color: #fff;
  }
  th, td {
    padding: 12px 14px;
    border: 1px solid #1a2138;
    text-align: center;
  }
  thead tr {
    background-color: var(--primary);
  }
  tbody tr:nth-child(odd) {
    background-color: #2a2f4b;
  }
  tbody tr:hover {
    background-color: #3b8bee90;
  }
  .avatar-preview {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 12px #12183fbb;
    margin-bottom: 15px;
  }
  #modal {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffcf46cc;
    padding: 16px 32px;
    border-radius: 16px;
    color: #232323;
    font-weight: 700;
    user-select: none;
    display: none;
    z-index: 9999;
    font-size: 1.1rem;
  }
  #buzz-lock-msg {
    color: var(--accent);
    font-weight: 700;
    margin-top: 18px;
    text-align: center;
    min-height: 24px;
    user-select: none;
  }
</style>
</head>
<body>

<header>
  <h1>Quiz Buzzer Pro</h1>
  <nav>
    <a href="#" onclick="navigate('login')">Login</a>
    <a href="#" onclick="navigate('register')">Register</a>
    <a href="#" onclick="navigate('home')" id="nav-home" style="display:none;">Home</a>
    <a href="#" onclick="navigate('profile')" id="nav-profile" style="display:none;">Profile</a>
    <a href="#" onclick="navigate('host')" id="nav-host" style="display:none;">Host Game</a>
    <a href="#" onclick="navigate('join')" id="nav-join" style="display:none;">Join Game</a>
    <a href="#" onclick="navigate('adminPanel')" id="nav-admin" style="display:none;">Admin Panel</a>
    <a href="#" onclick="navigate('scoreboard')" id="nav-scoreboard" style="display:none;">Scoreboard</a>
    <a href="#" onclick="logout()" id="nav-logout" style="display:none; color: var(--danger);">Logout</a>
  </nav>
</header>

<main id="main-content">
  <!-- Content will be loaded here -->
</main>

<div id="modal"></div>

<script>
  // Firebase Initialization
  const firebaseConfig = {
    apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
    authDomain: "buzzer-a0d53.firebaseapp.com",
    databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "buzzer-a0d53",
    storageBucket: "buzzer-a0d53.appspot.com",
    messagingSenderId: "29031182202",
    appId: "1:29031182202:web:447d951b38be59b29270c3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Global State
  let currentUser = null;
  let currentRole = null;
  let gameID = "";
  let playerID = "";
  let teamName = "";

  let buzzLockSoundPlayed = false;

  // Utility: Show modal message
  function showModal(msg, duration=1800){
    const modal = document.getElementById('modal');
    modal.textContent = msg;
    modal.style.display = 'block';
    clearTimeout(modal._timer);
    modal._timer = setTimeout(() => modal.style.display = 'none', duration);
  }

  // Navigation and views
  const content = document.getElementById('main-content');

  function setNavLinks(){
    document.getElementById('nav-home').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-profile').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-host').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-join').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-scoreboard').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-admin').style.display = currentRole === "admin" ? 'inline-block' : 'none';
    document.getElementById('nav-logout').style.display = currentUser ? 'inline-block' : 'none';
  }

  function navigate(page){
    // Clear current listeners
    if(window.cleanupListener) {
      window.cleanupListener();
      window.cleanupListener = null;
    }
    switch(page){
      case 'login':        renderLogin(); break;
      case 'register':     renderRegister(); break;
      case 'home':         if(!currentUser) { navigate('login'); return; } renderHome(); break;
      case 'profile':      if(!currentUser) { navigate('login'); return; } renderProfile(); break;
      case 'host':         if(!currentUser) { navigate('login'); return; } renderHost(); break;
      case 'join':         if(!currentUser) { navigate('login'); return; } renderJoin(); break;
      case 'adminPanel':   if(currentRole !== "admin") { navigate('home'); return; } renderAdminPanel(); break;
      case 'scoreboard':   if(!currentUser) { navigate('login'); return; } renderOverallScoreboard(); break;
      case 'playerGame':   if(!currentUser) { navigate('login'); return; } renderPlayerGame(); break;
      default: renderLogin();
    }
    setNavLinks();
  }

  function clearContent(){
    content.innerHTML = "";
  }

  // -- LOGIN PAGE --
  function renderLogin(){
    clearContent();
    content.innerHTML = `
      <h2>Login</h2>
      <input id="login-username" placeholder="Username" autocomplete="off" />
      <input id="login-password" placeholder="Password" type="password" />
      <button id="login-btn">Login</button>
      <p>Don't have an account? <a href="#" id="goRegister">Register here</a></p>
    `;
    document.getElementById('login-btn').onclick = loginUser;
    document.getElementById('goRegister').onclick = (e) => { e.preventDefault(); navigate('register'); };
  }

  // -- REGISTER PAGE --
  function renderRegister(){
    clearContent();
    content.innerHTML = `
      <h2>Register</h2>
      <input id="register-username" placeholder="Username" autocomplete="off" />
      <input id="register-password" placeholder="Password" type="password" />
      <input id="register-email" placeholder="Email" type="email" />
      <input id="register-avatar" type="file" accept="image/*" />
      <img id="register-avatar-preview" class="avatar-preview" style="display:none;" />
      <button id="register-btn">Register</button>
      <p>Already have an account? <a href="#" id="goLogin">Login here</a></p>
    `;
    const avatarInput = document.getElementById('register-avatar');
    const avatarPreview = document.getElementById('register-avatar-preview');
    avatarInput.addEventListener('change', e => {
      const file = avatarInput.files[0];
      if(!file){
        avatarPreview.style.display = "none";
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        avatarPreview.src = e.target.result;
        avatarPreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
    document.getElementById('register-btn').onclick = registerUser;
    document.getElementById('goLogin').onclick = (e) => { e.preventDefault(); navigate('login'); };
  }

  // -- HOME PAGE --
  function renderHome(){
    clearContent();
    content.innerHTML = `
      <h2>Welcome, ${currentUser}!</h2>
      <div style="text-align:center; margin-top:20px;">
        <a href="#" id="goHost" class="btn">Host Game</a>
        <a href="#" id="goJoin" class="btn">Join Game</a>
        <a href="#" id="goProfile" class="btn">Profile</a>
        <a href="#" id="goScoreboard" class="btn">Overall Scoreboard</a>
        ${currentRole === 'admin' ? '<a href="#" id="goAdmin" class="btn" style="background: var(--danger);">Admin Panel</a>' : ''}
      </div>
    `;
    document.getElementById('goHost').onclick = e => { e.preventDefault(); navigate('host'); };
    document.getElementById('goJoin').onclick = e => { e.preventDefault(); navigate('join'); };
    document.getElementById('goProfile').onclick = e => { e.preventDefault(); navigate('profile'); };
    document.getElementById('goScoreboard').onclick = e => { e.preventDefault(); navigate('scoreboard'); };
    if(currentRole === 'admin'){
      document.getElementById('goAdmin').onclick = e => { e.preventDefault(); navigate('adminPanel'); };
    }
  }

  // -- PROFILE PAGE --
  function renderProfile(){
    clearContent();
    db.ref('users/' + currentUser).get().then(snap=>{
      const user = snap.val() || {};
      const avatarSrc = user.avatar || '';
      content.innerHTML = `
        <h2>Your Profile</h2>
        <img id="profile-avatar-preview" class="avatar-preview" src="${avatarSrc}" style="${avatarSrc ? '' : 'display:none;'}"/>
        <input id="profile-email" placeholder="Email" type="email" value="${user.email || ''}" />
        <input id="profile-password" placeholder="New Password" type="password" />
        <input id="profile-avatar" type="file" accept="image/*" />
        <button id="saveProfileBtn">Save Changes</button>
      `;
      const avatarInput = document.getElementById('profile-avatar');
      const avatarPreview = document.getElementById('profile-avatar-preview');
      avatarInput.addEventListener('change', e => {
        const file = avatarInput.files[0];
        if(!file){
          avatarPreview.style.display = "none";
          avatarPreview.src = "";
          return;
        }
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          avatarPreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      });
      document.getElementById('saveProfileBtn').onclick = updateProfile;
    });
  }

  // -- HOST PAGE --
  function renderHost(){
    clearContent();
    const code = (Math.floor(Math.random()*900000)+100000).toString();
    gameID = code;
    currentRole = 'admin';
    db.ref('games/'+code).set({
      created: Date.now(),
      status: 'waiting',
      round: 1,
      question: '',
      image: '',
      players: {},
      buzzer: '',
      totalScores: {}
    });
    content.innerHTML = `
      <h2>Host Game</h2>
      <input id="host-code" readonly value="${code}" />
      <button id="startGameBtn">Start Game</button>
    `;
    document.getElementById('startGameBtn').onclick = () => {
      db.ref('games/'+gameID).update({status:'live', round:1});
      navigate('adminPanel');
    };
  }

  // -- JOIN PAGE --
  function renderJoin(){
    clearContent();
    content.innerHTML = `
      <h2>Join Game</h2>
      <input id="join-code" placeholder="Game Code (6 digits)" maxlength="6" />
      <input id="join-team" placeholder="Team Name (optional)" maxlength="24" />
      <button id="joinGameBtn">Join</button>
    `;
    document.getElementById('joinGameBtn').onclick = joinGame;
  }

  // -- ADMIN PANEL --
  function renderAdminPanel(){
    clearContent();
    content.innerHTML = `
      <h2>Admin Panel - Game <span id="roomcode"></span></h2>
      <div id="question-section" style="margin-bottom: 12px;">
        <div id="question-text" style="font-size:2rem; font-weight: 700; min-height: 3rem; margin-bottom: 10px;"></div>
        <img id="question-img" alt="Question Image" style="max-width: 100%; max-height: 240px; border-radius: 16px; cursor: zoom-in;"/>
      </div>
      <input id="admin-question-input" type="text" placeholder="Enter question here" />
      <input id="admin-image-file" type="file" accept="image/*" />
      <img id="admin-image-preview" style="display:none; max-width: 100%; max-height: 250px; margin-bottom: 14px;" />
      <button id="uploadQuestionBtn">Upload Question & Image</button>
      <div id="host-controls" style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center;">
        <input id="host-team" placeholder="Team Name" />
        <input id="host-points" type="number" value="10" style="width: 80px;" />
        <button id="addPointsBtn">Add Points to Team</button>
      </div>
      <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
        <button id="resetBuzzersBtn">Reset Buzzers</button>
        <button id="resetRoundBtn">Reset Round</button>
        <button id="nextRoundBtn">Next Round</button>
        <button id="clearScoresBtn">Clear All Scores</button>
        <button id="backToHomeBtn" style="background: var(--danger);">Back to Home</button>
      </div>
      <div class="scoreboard" id="admin-scoreboard" style="margin-top: 20px;"></div>
      <div id="buzzed-who" style="margin-top: 12px; font-weight: 700; color: var(--accent); text-align: center;"></div>
    `;
    document.getElementById('roomcode').textContent = gameID;

    // Event handlers
    document.getElementById('uploadQuestionBtn').onclick = uploadQuestion;
    document.getElementById('addPointsBtn').onclick = addPoints;
    document.getElementById('resetBuzzersBtn').onclick = resetBuzzers;
    document.getElementById('resetRoundBtn').onclick = resetRound;
    document.getElementById('nextRoundBtn').onclick = nextRound;
    document.getElementById('clearScoresBtn').onclick = clearAllScores;
    document.getElementById('backToHomeBtn').onclick = ()=>navigate('home');

    let imgFileInput = document.getElementById('admin-image-file');
    imgFileInput.addEventListener('change', e=>{
      const preview = document.getElementById('admin-image-preview');
      if(imgFileInput.files.length > 0){
        const reader = new FileReader();
        reader.onload = ev => {
          preview.src = ev.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(imgFileInput.files[0]);
      } else {
        preview.style.display = 'none';
        preview.src = '';
      }
    });

    loadAdminGame();
  }

  // -- PLAYER GAME --
  function renderPlayerGame(){
    clearContent();
    content.innerHTML = `
      <div style="flex: 1; display:flex; flex-direction: column; align-items: center;">
        <div id="player-question-text" style="font-size:2.7rem; font-weight: 900; margin-bottom: 24px; text-align:center;"></div>
        <img id="player-question-img" alt="Question Image" style="max-width: 100%; max-height: 240px; border-radius: 16px; cursor: zoom-in;"/>
      </div>
      <div style="flex: 1; display:flex; flex-direction: column; align-items: stretch; justify-content: flex-start; gap:10px;">
        <button id="player-buzzer" class="buzzer-btn">BUZZ!</button>
        <div id="buzz-lock-msg" class="buzz-lock-msg"></div>
        <div class="btn-group">
          <button id="score-individual-btn">Individual Scores</button>
          <button id="score-team-btn">Team Scores</button>
        </div>
        <div class="scoreboard" id="player-scoreboard"></div>
        <div id="host-controls" style="margin-top: 15px; display: none; justify-content: center; gap: 12px;">
          <input placeholder="Team Name" id="host-team" />
          <input type="number" value="10" id="host-points" style="width: 80px;" />
          <button id="addPointsBtnPlayer">Add Points</button>
        </div>
        <button id="leaveGameBtn" style="margin-top: 20px; background: var(--danger);">Leave Game</button>
      </div>
    `;
    document.getElementById('player-buzzer').onclick = tryBuzz;
    document.getElementById('leaveGameBtn').onclick = leaveGame;
    document.getElementById('score-individual-btn').onclick = () => {currentScoreboardMode = 'individual'; listenPlayerGame();}
    document.getElementById('score-team-btn').onclick = () => {currentScoreboardMode = 'team'; listenPlayerGame();}
    document.getElementById('addPointsBtnPlayer').onclick = addPoints;
    listenPlayerGame();
    listenQuestionPlayer();
  }

  // -- OVERALL SCOREBOARD --
  function renderOverallScoreboard(){
    clearContent();
    content.innerHTML = `
      <h2>Overall Scoreboard</h2>
      <div class="scoreboard" style="max-height:600px; overflow-y:auto;">
        <table id="overall-scoreboard-table"></table>
      </div>
      <button onclick="navigate('home')" style="margin-top: 24px;">Back to Home</button>
    `;
    loadOverallScoreboard();
  }

  // -- Data Manipulation Functions (partial for brevity) --

  // Show or hide nav links depending on login and role
  function updateNav(){
    document.getElementById('nav-home').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-profile').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-host').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-join').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-scoreboard').style.display = currentUser ? 'inline-block' : 'none';
    document.getElementById('nav-admin').style.display = currentRole === 'admin' ? 'inline-block' : 'none';
    document.getElementById('nav-logout').style.display = currentUser ? 'inline-block' : 'none';
  }

  // Login logic
  function loginUser(){
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value.trim();
    if(!u || !p) return showModal('Fill username and password');
    if(u.toLowerCase()==='admin' && p==='24207'){
      currentUser = 'admin';
      currentRole = 'admin';
      updateNav();
      navigate('home');
      return;
    }
    db.ref('users/'+u).get().then(snap=>{
      if(!snap.exists()) return showModal('User not found');
      const user = snap.val();
      if(user.pw !== p) return showModal('Wrong password');
      currentUser = u;
      currentRole = user.role || 'user';
      updateNav();
      navigate('home');
    });
  }

  // Register logic
  function registerUser(){
    const u = document.getElementById('register-username').value.trim();
    const p = document.getElementById('register-password').value.trim();
    const e = document.getElementById('register-email').value.trim();
    const avatarFile = document.getElementById('register-avatar').files[0];
    if(!u || !p|| !e) return showModal('All fields required');
    if(u.toLowerCase() === 'admin') return showModal('Username "admin" reserved');
    db.ref('users/'+u).get().then(snap=>{
      if(snap.exists()) return showModal('Username already exists');
      const saveUser = (avatarData) => {
        db.ref('users/'+u).set({pw:p,email:e,role:'user',avatar:avatarData || ''}).then(()=>{
          showModal('Registered! Please login');
          setTimeout(()=>navigate('login'), 1500);
        });
      };
      if(avatarFile){
        const reader = new FileReader();
        reader.onload = e => saveUser(e.target.result);
        reader.readAsDataURL(avatarFile);
      } else {
        saveUser('');
      }
    });
  }

  // Profile logic implemented earlier should be adjusted similarly...

  // Join game logic
  function joinGame(){
    const code = document.getElementById('join-code').value.trim();
    teamName = document.getElementById('join-team').value.trim() || null;
    if(!/^\d{6}$/.test(code)) return showModal('Enter a valid 6-digit game code');
    if(!currentUser) return showModal('Please login first');
    gameID = code;
    playerID = btoa(currentUser + Math.random()).replace(/=/g, '');
    currentRole = 'player';
    db.ref('games/'+gameID).get().then(snap=>{
      if(!snap.exists()) return showModal('Game not found');
      db.ref('users/'+currentUser).get().then(usnap=>{
        const avatar = usnap.val()?.avatar || '';
        db.ref(`games/${gameID}/players/${playerID}`).set({
          name: currentUser,
          team: teamName,
          score: 0,
          buzzed: false,
          avatar,
          joined: Date.now()
        }).then(()=>{
          navigate('playerGame');
        });
      });
    });
  }

  // Listen player UI and buzz buzzer
  let lastBuzzTime = 0;
  function tryBuzz(){
    const now = performance.now();
    if(now - lastBuzzTime < 10) return; // very fast debounce
    lastBuzzTime = now;
    db.ref(`games/${gameID}/buzzer`).once('value').then(snap=>{
      if(snap.val()) return showModal('Buzzer locked!');
      db.ref(`games/${gameID}/players/${playerID}`).update({buzzed:true});
      db.ref(`games/${gameID}`).update({buzzer: playerID});
      const buzzAudio = document.getElementById('buzz-audio');
      buzzAudio.currentTime = 0;
      buzzAudio.play().catch(()=>{});
    });
  }

  // Listen player game to update buzz/button/scoreboard
  function listenPlayerGame(){
    db.ref('games/'+gameID).on('value', snap=>{
      const g = snap.val() || {};
      const buzzer = g.buzzer || '';
      const players = g.players || {};
      const playerList = Object.entries(players).map(([id,val])=>({...val,id}));
      playerList.sort((a,b) => (b.score||0)-(a.score||0));
      buildPlayerScoreboard(playerList);

      const buzzBtn = document.getElementById('player-buzzer');
      if(buzzer && buzzer !== playerID){
        buzzBtn.disabled = true;
        document.getElementById('buzz-lock-msg').textContent = `Buzzer locked by ${players[buzzer]?.name || 'someone'}`;
      } else {
        buzzBtn.disabled = false;
        document.getElementById('buzz-lock-msg').textContent = '';
      }

      if(buzzer && buzzer !== playerID && !buzzLockSoundPlayed){
        buzzLockSoundPlayed = true;
        const buzzAudio = document.getElementById('buzz-audio');
        buzzAudio.currentTime = 0;
        buzzAudio.play().catch(() => {});
      } else if(!buzzer){
        buzzLockSoundPlayed = false;
      }
    });
  }

  function buildPlayerScoreboard(playerList){
    if(currentScoreboardMode === 'individual'){
      let html = '<table><thead><tr><th>Player</th><th>Team</th><th>Score</th></tr></thead><tbody>';
      playerList.forEach(p => {
        html += `<tr><td>${p.name}</td><td>${p.team || '-'}</td><td>${p.score || 0}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('player-scoreboard').innerHTML = html;
    } else {
      const teamScores = {};
      playerList.forEach(p => {
        if(p.team) teamScores[p.team] = (teamScores[p.team]||0) + (p.score||0);
      });
      const sorted = Object.entries(teamScores).sort((a,b) => b[1] - a[1]);
      let html = '<table><thead><tr><th>Team</th><th>Total Score</th></tr></thead><tbody>';
      sorted.forEach(([team,score])=> {
        html += `<tr><td>${team}</td><td>${score}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('player-scoreboard').innerHTML = html;
    }
  }

  // Show overall scoreboard with accumulated scores
  function loadOverallScoreboard(){
    db.ref("games").once("value").then(snap=>{
      const games = snap.val()||{};
      const totals = {};
      for(const gid in games){
        if(!games[gid].totalScores) continue;
        for(const pid in games[gid].totalScores){
          totals[pid] = (totals[pid]||0)+games[gid].totalScores[pid];
        }
      }
      let sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]);

      if(sorted.length === 0){
        document.getElementById('overall-scoreboard-table').innerHTML = "<tbody><tr><td colspan='3'>No scores yet</td></tr></tbody>";
        return;
      }
      let promises = sorted.map(([pid], i) => {
        return db.ref("games").get().then(snapshot => {
          let foundName = "Unknown";
          snapshot.forEach(gameSnap =>{
            const p = gameSnap.val().players?.[pid];
            if(p && p.name){
              foundName = p.name;
              return true;
            }
          });
          sorted[i].push(foundName);
        });
      });
      Promise.all(promises).then(() =>{
        let html = '<thead><tr><th>Rank</th><th>Player</th><th>Total Points</th></tr></thead><tbody>';
        sorted.forEach(([pid,score,name],i) =>{
          html += `<tr><td>${i+1}</td><td style="color:#ffe05b;">${name}</td><td>${score}</td></tr>`;
        });
        html += '</tbody>';
        document.getElementById('overall-scoreboard-table').innerHTML = html;
      });
    });
  }

  // Logout function
  function logout(){
    currentUser = null;
    currentRole = null;
    gameID = '';
    playerID = '';
    teamName = '';
    updateNav();
    navigate('login');
  }

  // Initialization on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateNav();
    navigate('login');
  });

</script>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>
</body>
</html>
