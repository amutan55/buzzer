<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {margin:0; padding:0; height:100%; font-family:'Montserrat', Arial,sans-serif;
    background:var(--main-bg); color:#fff; user-select:none;}
  .page {display:none; max-width:720px; margin:0 auto; padding:28px 32px;}
  .show {display:block;}
  h1,h2,h3 {font-weight:700; margin-bottom:24px; text-align:center;}
  input[type=text], input[type=password], input[type=email], input[type=file] {
    width:100%; max-width:420px; padding:14px 18px; font-size:1.2em;
    border-radius:var(--radius); border:none; margin:12px auto 24px auto;
    background:#344365; color:#fff; text-align:center;
  }
  input::placeholder{color:#bac3e6;}
  button {background:var(--primary); color:#fff; font-weight:700; font-size:1.2em;
    border:none; border-radius:48px; padding:16px 18px; box-shadow:0 6px 13px #2554a180;
    cursor:pointer; margin:12px auto; display:block;}
  button:hover:not(:disabled){background:var(--accent); color:#232;}
  .buzzer-btn {background:var(--accent); color:#141c34; font-size:4rem; font-weight:900;
    padding:60px 140px; border-radius:160px; border:12px solid #fff; box-shadow:0 14px 64px #ffea6fcc;
    cursor:pointer; margin:24px auto;}
  .buzzer-btn:disabled{background:#eee; color:#888; border-color:#aaa;}
  .scoreboard{width:100%; background:#222947; padding:18px; border-radius:20px;}
  .buzzed-tag{background:var(--accent); color:#232; padding:4px 10px; border-radius:12px; font-weight:700;}
  /* player layout split */
  .player-split{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;}
  .player-left{flex:1; min-width:280px;}
  .player-right{flex:1; min-width:280px; display:flex; flex-direction:column; align-items:center;}
  #player-question-text{font-size:2.2em; font-weight:800; margin:18px 0; text-align:center;}
  #player-question-img{max-width:100%; max-height:280px; border-radius:16px; margin:12px auto; display:none; cursor:zoom-in;}
  #player-question-img.zoomed{transform:scale(2); cursor:zoom-out; position:relative; z-index:9999; box-shadow:0 0 20px #ffea6f;}
  .toggle-scores{display:flex; gap:12px; justify-content:center;}
</style>
</head>
<body>
<div id="page-login" class="page show">
  <div class="center-box">
    <h1>Login</h1>
    <input id="login-username" placeholder="Username"/>
    <input id="login-password" type="password" placeholder="Password"/>
    <button onclick="loginUser()">Login</button>
    <button onclick="showRegister()">Register</button>
  </div>
</div>

<div id="page-register" class="page">
  <div class="center-box">
    <h1>Register</h1>
    <input id="register-username" placeholder="Username"/>
    <input id="register-password" type="password" placeholder="Password"/>
    <input id="register-email" type="email" placeholder="Email"/>
    <button onclick="registerUser()">Register</button>
    <button onclick="showLogin()">Back</button>
  </div>
</div>

<div id="page-home" class="page">
  <div class="center-box">
    <h2>Welcome, <span id="welcome-user"></span>!</h2>
    <button onclick="hostPage()">Host Game</button>
    <button onclick="joinPage()">Join Game</button>
    <button onclick="showProfile()">Profile</button>
    <button onclick="showScoreboard()">Scoreboard</button>
  </div>
</div>

<div id="page-host" class="page">
  <div class="center-box">
    <h2>Host Game</h2>
    <input id="host-code" readonly/>
    <button onclick="startGame()">Start</button>
  </div>
</div>

<div id="page-admin-panel" class="page">
  <div class="center-box">
    <h2>Admin Panel</h2>
    <div><b>Game:</b> <span id="roomcode"></span></div>
    <div id="question-text"></div>
    <input id="admin-question-input" placeholder="Enter question"/>
    <button onclick="uploadQuestion()">Upload</button>
    <table id="admin-scores"></table>
    <div id="team-controls"></div>
  </div>
</div>

<div id="page-join" class="page">
  <div class="center-box">
    <h2>Join</h2>
    <input id="join-code" placeholder="Game Code"/>
    <input id="join-team" placeholder="Team"/>
    <button onclick="joinGame()">Join</button>
  </div>
</div>

<div id="page-player" class="page">
  <div class="center-box">
    <h2>Quiz Buzzer</h2>
    <div class="player-split">
      <div class="player-left">
        <div id="player-question-text"></div>
        <img id="player-question-img"/>
      </div>
      <div class="player-right">
        <div>Hello, <span id="pl-name"></span>!</div>
        <div><b>Game:</b> <span id="pl-room"></span></div>
        <div><b>Team:</b> <span id="pl-team"></span></div>
        <button id="player-buzzer" class="buzzer-btn" onclick="buzz()">BUZZ!</button>
        <div id="buzz-lock-msg"></div>
        <div class="toggle-scores">
          <button onclick="scoreView='individual';renderScores();">Individual</button>
          <button onclick="scoreView='team';renderScores();">Team</button>
        </div>
        <div class="scoreboard" id="player-scores"></div>
      </div>
    </div>
  </div>
</div>

<div id="page-scoreboard" class="page">
  <div class="center-box"><h2>Overall Scores</h2>
    <table id="scoreboard-table"></table>
  </div>
</div>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>

<script>
// Firebase init
const firebaseConfig={apiKey:"...",authDomain:"...",databaseURL:"...",projectId:"..."};
firebase.initializeApp(firebaseConfig);const db=firebase.database();

let myUser="",myPID="",myTeam="",gameID="",scoreView="individual",buzzPlayed=false,currentGameSnapshot={};

function showPage(id){document.querySelectorAll(".page").forEach(p=>p.classList.remove("show"));document.getElementById(id).classList.add("show");}
function loginUser(){myUser=document.getElementById("login-username").value;showHome();}
function registerUser(){showLogin();}
function showRegister(){showPage("page-register");}
function showLogin(){showPage("page-login");}
function showHome(){document.getElementById("welcome-user").textContent=myUser;showPage("page-home");}
function showProfile(){alert("Profile page");}

// Host / Admin
function hostPage(){showPage("page-host");gameID=String(Math.floor(Math.random()*900000+100000));document.getElementById("host-code").value=gameID;db.ref("games/"+gameID).set({players:{},buzzed:"",question:""});}
function startGame(){showPage("page-admin-panel");readAdmin();}
function uploadQuestion(){let q=document.getElementById("admin-question-input").value;db.ref("games/"+gameID).update({question:q});}

// Join
function joinPage(){showPage("page-join");}
function joinGame(){
  gameID=document.getElementById("join-code").value;myTeam=document.getElementById("join-team").value;
  myPID=btoa(myUser+Math.random());db.ref("games/"+gameID+"/players/"+myPID).set({name:myUser,team:myTeam,score:0});
  document.getElementById("pl-name").textContent=myUser;document.getElementById("pl-room").textContent=gameID;document.getElementById("pl-team").textContent=myTeam;
  showPage("page-player");listenPlayer();
}

// Buzz
function buzz(){db.ref("games/"+gameID).once("value").then(s=>{let g=s.val();if(g.buzzed)return;db.ref("games/"+gameID+"/players/"+myPID).update({buzzed:true});db.ref("games/"+gameID).update({buzzed:myPID});});}
document.addEventListener("keydown",e=>{if(document.getElementById("page-player").classList.contains("show")&&e.code==="Space"){e.preventDefault();buzz();}});

// Player
function listenPlayer(){
  db.ref("games/"+gameID).on("value",snap=>{
    let g=snap.val()||{};currentGameSnapshot=g;document.getElementById("player-question-text").textContent=g.question||"";
    document.getElementById("buzz-lock-msg").textContent=g.buzzed?"Locked":"";renderScores();
    if(g.buzzed&&!buzzPlayed){document.getElementById("buzz-audio").play();buzzPlayed=true;}if(!g.buzzed) buzzPlayed=false;
  });
}
function renderScores(){
  if(!currentGameSnapshot)return;let g=currentGameSnapshot;let html="";
  if(scoreView==="individual"){
    let arr=Object.entries(g.players||{}).map(([id,v])=>({...v,id}));arr.sort((a,b)=>(b.score||0)-(a.score||0));
    arr.forEach((pl,i)=>{html+=`${i+1}. <b style="color:#ffe05b">${pl.name}${pl.team?"("+pl.team+")":""}</b> ${pl.score||0} ${(pl.id===g.buzzed)?"<span class='buzzed-tag'>Buzzed</span>":""}<br>`;});
  }else{
    let ts={};Object.values(g.players||{}).forEach(pl=>{let t=pl.team||"(no team)";ts[t]=(ts[t]||0)+(pl.score||0);});
    Object.entries(ts).sort((a,b)=>b[1]-a).forEach(([t,pts],i)=>{html+=`${i+1}. <b style="color:#ffe05b">${t}</b> ${pts}<br>`;});
  }
  document.getElementById("player-scores").innerHTML=html||"(no players)";
}

// Admin
function readAdmin(){
  db.ref("games/"+gameID).on("value",snap=>{
    let g=snap.val()||{};document.getElementById("roomcode").textContent=gameID;document.getElementById("question-text").textContent=g.question||"";
    let arr=Object.entries(g.players||{}).map(([id,v])=>({...v,id}));arr.sort((a,b)=>(b.score||0)-(a.score||0));
    let html="<tr><th>Player</th><th>Score</th><th>Actions</th></tr>";
    arr.forEach(pl=>{html+=`<tr><td>${pl.name}${pl.team?"("+pl.team+")":""}</td><td>${pl.score||0}</td><td><button onclick="adminScore(25,'${pl.id}')">+25</button><button onclick="adminScore(-25,'${pl.id}')">-25</button></td></tr>`;});
    document.getElementById("admin-scores").innerHTML=html;
    let teams={};arr.forEach(pl=>{if(pl.team)teams[pl.team]=true;});
    let th="";Object.keys(teams).forEach(t=>{th+=`${t} <button onclick="adminTeamScore(25,'${t}')">+25</button><button onclick="adminTeamScore(-25,'${t}')">-25</button><br>`;});
    document.getElementById("team-controls").innerHTML=th;
  });
}
function adminScore(delta,pid){db.ref(`games/${gameID}/players/${pid}`).once("value").then(s=>{let v=s.val();db.ref(`games/${gameID}/players/${pid}`).update({score:(v.score||0)+delta});});}
function adminTeamScore(delta,team){db.ref(`games/${gameID}/players`).once("value").then(s=>{let ps=s.val()||{};Object.entries(ps).forEach(([pid,pl])=>{if(pl.team===team)db.ref(`games/${gameID}/players/${pid}`).update({score:(pl.score||0)+delta});});});}
</script>
</body>
</html>
