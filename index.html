<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />
<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {
    margin: 0; padding: 0; height: 100%; font-family: 'Montserrat', Arial, sans-serif;
    background: var(--main-bg); color: #fff; user-select: none;
  }
  .page {
    display: none; max-width: 720px; margin: 0 auto; padding: 28px 32px;
  }
  .show {
    display: block;
  }
  h1, h2, h3 {
    font-weight: 700; margin-bottom: 24px; text-align: center;
  }
  input[type=text], input[type=password], input[type=email], input[type=file] {
    width: 100%; max-width: 420px; padding: 14px 18px; font-size: 1.2em;
    border-radius: var(--radius); border: none; margin: 12px auto 24px auto;
    background: #344365; color: #fff; box-sizing: border-box; text-align: center;
  }
  input::placeholder { color: #bac3e6; }
  button {
    display: block; margin: 18px auto; max-width: 90vw; width: 320px;
    background: var(--primary); color: #fff;
    font-family: Montserrat; font-weight: 700; font-size: 1.3em;
    border: none; border-radius: 48px; padding: 18px 20px;
    cursor: pointer;
    box-shadow: 0 6px 13px #2554a180;
    user-select: none;
    transition: background 0.2s ease;
    text-align: center;
  }
  button:hover:not(:disabled) { background: var(--accent); color: #232323; }
  button:disabled { background: #ddd; color: #999; cursor: not-allowed; box-shadow: none; }
  label { color: #acbede; font-size: 1.05em; margin-bottom: 6px; display: block; user-select: none; }
  .buzzer-btn {
    background: var(--accent); color: #141c34;
    font-size: 4.8em; font-weight: 900;
    padding: 72px 180px; border-radius: 160px;
    border: 12px solid #fff;
    box-shadow: 0 14px 64px #ffea6fcc;
    cursor: pointer;
    user-select: none;
    max-width: 90vw;
    display: block; margin: 48px auto 56px auto;
  }
  .buzzer-btn:disabled {
    background: #eee; color: #888; border-color: #ccc; cursor: not-allowed; box-shadow: none;
  }
  .scoreboard {
    max-width: 720px; margin: 30px auto;
    background: #222947; padding: 18px 28px;
    box-shadow: 0 2px 14px #0008; border-radius: 20px;
    color: #fff;
    overflow-x: auto;
  }
  table {
    width: 100%; border-collapse: collapse; color: #fff;
  }
  thead tr { background: var(--primary); }
  th, td {
    padding: 14px 10px; border: 1px solid #1a2138; text-align: center;
  }
  tbody tr:nth-child(odd) { background: #2a2f4b; }
  tbody tr:hover { background-color: #3b8bee90; }
  .avatar-column img {
    width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
  }
  .buzzed-tag {
    background: var(--accent); color: #232323;
    border-radius: 14px; padding: 6px 14px;
    font-size: 1.1em; user-select: none; font-weight: 700;
  }
  #buzz-lock-msg, #buzzed-who {
    color: var(--accent); font-weight: 700; text-align: center; user-select:none;
  }
  #buzz-lock-msg { margin-top: 15px; font-size: 1.3em; }
  #buzzed-who { font-size: 1.8em; margin: 30px 0 24px 0; }
  #question-text, #player-question-text {
    font-size: 2.9em; font-weight: 900; margin: 30px auto 24px auto;
    max-width: 90vw; word-break: break-word; text-align: center;
  }
  #question-img, #player-question-img {
    max-width: 90vw; max-height: 400px;
    border-radius: 24px; margin: 0 auto 30px auto;
    display: block; object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
    z-index: 1;
  }
  #question-img.zoomed, #player-question-img.zoomed {
    transform: scale(2);
    cursor: zoom-out;
    position: relative;
    z-index: 9999;
    box-shadow: 0 0 20px #ffea6fcc;
  }
  .backbtn {
    position: fixed; bottom: 24px; left: 50%;
    transform: translateX(-50%);
    font-size: 1.3em; padding: 12px 40px;
    border-radius: 44px; background: #364063; color: white;
    border: none; cursor: pointer;
    box-shadow: 0 5px 16px #000a;
    user-select: none; z-index: 1100;
    transition: background 0.3s ease;
  }
  .backbtn:hover {
    background: var(--accent); color: #232323;
  }
  .center-box {
    max-width: 720px; margin: 0 auto;
    padding: 30px 24px;
    background: #2b3250; border-radius: 24px;
    box-shadow: 0 4px 38px #232f66bb;
    display: flex; flex-direction: column; align-items: center;
  }
  .avatar-preview { width: 72px; height: 72px; border-radius: 50%; margin-bottom: 22px; object-fit: cover; box-shadow: 0 0 12px #12183fbb; }
</style>
</head>
<body>

<button class="backbtn" id="backbtn" style="display:none" onclick="backButtonHandler()">‚Üê Back</button>
<div id="modal" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:18px 32px;background:#ffcf46cc;border-radius:16px;color:#232323;font-weight:700;display:none;user-select:none;z-index:9999;"></div>

<!-- Login -->
<div id="page-login" class="page show">
  <div class="center-box">
    <h1>Login</h1>
    <input type="text" id="login-username" placeholder="Username" maxlength="24" autocomplete="off" />
    <input type="password" id="login-password" placeholder="Password" maxlength="24" />
    <button onclick="loginUser()">Login</button>
    <button onclick="showRegister()">Register</button>
    <div id="footer">DEVELOPED BY AMUTAN GROUP</div>
  </div>
</div>

<!-- Register -->
<div id="page-register" class="page">
  <div class="center-box">
    <h1>Register</h1>
    <input type="text" id="register-username" placeholder="Username" maxlength="24" autocomplete="off" />
    <input type="password" id="register-password" placeholder="Password" maxlength="24" />
    <input type="email" id="register-email" placeholder="Email" />
    <input type="file" id="register-avatar" accept="image/*" />
    <img id="register-avatar-preview" class="avatar-preview" style="display:none;" />
    <button onclick="registerUser()">Register</button>
    <button onclick="showLogin()">Back</button>
    <div id="footer">DEVELOPED BY AMUTAN GROUP</div>
  </div>
</div>

<!-- Home -->
<div id="page-home" class="page">
  <div class="center-box">
    <h2>Welcome, <span id="welcome-user"></span>!</h2>
    <button onclick="hostPage()">Host Game</button>
    <button onclick="joinPage()">Join Game</button>
    <button onclick="showProfile()">Profile</button>
    <button id="adminPanelBtn" onclick="adminPanel()" style="display:none;">Admin Panel</button>
    <button onclick="showScoreboard()">Scoreboard</button>
    <div id="footer">DEVELOPED BY AMUTAN GROUP</div>
  </div>
</div>

<!-- Profile -->
<div id="page-profile" class="page">
  <div class="center-box">
    <h2>Your Profile</h2>
    <img id="profile-avatar-preview" class="avatar-preview" style="display:none;" />
    <input type="text" id="profile-nickname" placeholder="Nickname" maxlength="24" readonly />
    <input type="password" id="profile-password" placeholder="New Password" maxlength="24" />
    <input type="email" id="profile-email" placeholder="Email" />
    <input type="file" id="profile-avatar" accept="image/*" />
    <button onclick="updateProfile()">Save Changes</button>
  </div>
</div>

<!-- Admin User Management -->
<div id="page-users" class="page">
  <div class="center-box" style="max-width: 720px;">
    <h2>User Management <span style="color:#ffe05b">(Admin)</span></h2>
    <table>
      <thead><tr><th>Avatar</th><th>Username</th><th>Email</th><th>Role</th><th>Delete</th></tr></thead>
      <tbody id="userlist"></tbody>
    </table>
    <input type="text" id="create-username" placeholder="New Username" />
    <input type="password" id="create-password" placeholder="New Password" />
    <input type="email" id="create-email" placeholder="Email" />
    <input type="file" id="create-avatar" accept="image/*" />
    <img id="create-avatar-preview" class="avatar-preview" style="display:none;" />
    <button onclick="createUser()">Create User</button>
  </div>
</div>

<!-- Host -->
<div id="page-host" class="page">
  <div class="center-box">
    <h2>Host Game</h2>
    <label>Game Code:</label><br />
    <input type="text" id="host-code" readonly /><br />
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<!-- Admin -->
<div id="page-admin-panel" class="page">
  <div class="center-box">
    <h2>Admin Control</h2>
    <div><b>Game Code:</b> <span id="roomcode"></span></div>
    <div><b>Round:</b> <span id="round-label"></span></div>
    <div id="question-holder">
      <div id="question-text"></div>
      <img id="question-img" alt="Question Image" />
    </div>
    <input type="text" id="admin-question-input" placeholder="Enter question here" /><br />
    <input type="file" id="admin-image-file" accept="image/*" /><br />
    <img id="admin-image-preview" style="display:none; max-width: 100%; max-height: 250px; margin-bottom: 14px;" />
    <button onclick="uploadQuestion()">Upload Question</button>
    <div style="display:flex; flex-wrap: wrap; gap: 12px; margin-top: 18px;">
      <button onclick="resetBuzzers()">Reset Buzzer</button>
      <button onclick="resetRound()">Reset Round</button>
      <button onclick="nextRound()">Next Round</button>
      <button onclick="clearAllScores()">Clear All Scores</button>
    </div>
    <table id="admin-scores" style="width: 100%; background: #222947; color:#fff; border-radius: 14px; margin-top: 18px;"></table>
    <div id="buzzed-who" style="margin-top: 22px;"></div>
  </div>
</div>

<!-- Join -->
<div id="page-join" class="page">
  <div class="center-box">
    <h2>Join Game</h2>
    <input type="text" id="join-code" maxlength="6" placeholder="Game Code" autocomplete="off" />
    <input type="text" id="join-team" maxlength="24" placeholder="Team Name (optional)" />
    <button onclick="joinGame()">Join</button>
  </div>
</div>

<!-- Player -->
<div id="page-player" class="page">
  <div class="center-box">
    <h2>Quiz Buzzer</h2>
    <img id="player-avatar-preview" style="width:80px; height:80px; border-radius:50%; margin-bottom:18px; display:none;" />
    <div style="color:#ffe05b; font-weight:700; font-size:1.4em; margin-bottom:10px;">
      Hello, <span id="pl-name"></span>!
    </div>
    <div><b>Game Code:</b> <span id="pl-room"></span></div>
    <div><b>Team:</b> <span id="pl-team"></span></div>
    <div id="player-question-text" style="font-size:2.5em; font-weight:700; margin:30px 0 15px 0; max-width: 90vw; text-align:center;"></div>
    <img id="player-question-img" src="" alt="Player Question Image" style="display:none; max-width:90vw; max-height:350px; border-radius:20px; margin-bottom:25px; cursor: zoom-in; transition: transform 0.3s ease;"/>
    <button id="player-buzzer" class="buzzer-btn" onclick="buzz()">BUZZ!</button>
    <div id="buzz-lock-msg"></div>
    <div class="scoreboard" id="player-scores"></div>
  </div>
</div>

<!-- Scoreboard (cumulative) -->
<div id="page-scoreboard" class="page">
  <div class="center-box">
    <h2>Overall Scoreboard</h2>
    <table id="scoreboard-table" style="width: 100%; background:#222947; color:#fff; border-radius: 14px;"></table>
  </div>
</div>

<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
    authDomain: "buzzer-a0d53.firebaseapp.com",
    databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "buzzer-a0d53",
    storageBucket: "buzzer-a0d53.appspot.com",
    messagingSenderId: "29031182202",
    appId: "1:29031182202:web:447d951b38be59b29270c3",
    measurementId: "G-NP0DMX7TKJ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let gameID = "", myRole = "", myUser = "", myTeam = "", myPID = "", buzzLockSoundPlayed = false;
  let pageHistory = [];

  function showPage(id){
    document.querySelectorAll('.page').forEach(el => el.classList.remove('show'));
    document.getElementById(id).classList.add('show');
    document.getElementById('backbtn').style.display = (id === 'page-login') ? 'none' : 'inline-block';
  }

  function backButtonHandler(){
    if(pageHistory.length > 1){
      pageHistory.pop();
      showPage(pageHistory[pageHistory.length -1]);
    }
  }

  function navigateToPage(id){
    if(pageHistory.length === 0 || pageHistory[pageHistory.length -1] !== id){
      pageHistory.push(id);
    }
    showPage(id);
  }

  // (All other core functions: registerUser, loginUser, updateProfile, adminPanel, reloadUsers, createUser,
  // deleteUser, hostPage, startGame, uploadQuestion, resetBuzzers, resetRound, nextRound,
  // adminScore, readAdmin, listenQuestionAdmin, joinPage, joinGame, listenPlayer,
  // listenQuestionPlayer, buzz, showScoreboard, clearAllScores, image zoom toggle...)

  // For image zoom toggle
  [document.getElementById("question-img"), document.getElementById("player-question-img")]
   .forEach(img => {
    img.addEventListener("click", () => {
      if(img.style.display === "none") return;
      img.classList.toggle("zoomed");
    });
  });

  // Show cumulative scoreboard aggregating all games scores
  function showScoreboard(){
    navigateToPage('page-scoreboard');
    db.ref('games').once('value').then(snap => {
      const games = snap.val() || {};
      const totalScores = {};
      for(const gid in games){
        const totals = games[gid].totalScores || {};
        for(const pid in totals){
          totalScores[pid] = (totalScores[pid] || 0) + totals[pid];
        }
      }
      const sorted = Object.entries(totalScores).sort((a,b) => b[1]-a[1]);
      if(sorted.length===0){
        document.getElementById('scoreboard-table').innerHTML = '<tbody><tr><td>No scores yet</td></tr></tbody>';
        return;
      }
      let html = '<thead><tr><th>Rank</th><th>Player</th><th>Total Points</th></tr></thead><tbody>';
      let promises = sorted.map(([pid,pts], idx) =>
        db.ref().child(`games`).once('value').then(allGamesSnap=>{
          for(const gameKey in allGamesSnap.val()){
            const plyrs = allGamesSnap.val()[gameKey].players || {};
            if(plyrs[pid]){
              const pname = plyrs[pid].name || "Unknown";
              html += `<tr><td>${idx+1}</td><td style="color:#ffe05b;">${pname}</td><td>${pts}</td></tr>`;
              break;
            }
          }
        })
      );
      Promise.all(promises).then(() => {
        html += '</tbody>';
        document.getElementById('scoreboard-table').innerHTML = html;
      });
    });
  }

  // Clear all scores function, admin only
  function clearAllScores(){
    if(myUser !== 'admin'){
      showModal('Only admin can clear all scores.');
      return;
    }
    db.ref('games').once('value').then(snap => {
      const games = snap.val() || {};
      for(const gid in games){
        if(games[gid].players){
          Object.keys(games[gid].players).forEach(pid => {
            db.ref(`games/${gid}/players/${pid}`).update({ score: 0, buzzed: false });
          });
        }
        db.ref(`games/${gid}`).update({ buzzed: "" });
        db.ref(`games/${gid}/totalScores`).remove();
      }
      showModal('All scores cleared.');
      if(gameID) readAdmin();
    });
  }

  // Add your other app logic and function implementations here...

</script>
<audio id="buzz-audio" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12d3b2760e.mp3" preload="auto"></audio>
</body>
</html>
