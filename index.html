<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quiz Buzzer Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet" />

<style>
  :root {
    --main-bg: #262e46;
    --primary: #3b8bee;
    --accent: #ffe05b;
    --danger: #e94f37;
    --radius: 16px;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Montserrat', Arial, sans-serif;
    background: var(--main-bg); color: #fff;
    user-select: none;
  }
  .page { display: none; max-width: 720px; margin: auto; padding: 28px; box-sizing: border-box; }
  .show { display: block; }
  h1,h2,h3 { font-weight:700; margin-bottom:24px; text-align:center; }
  input[type=text],input[type=password],input[type=email],input[type=file] {
    width:100%; max-width:420px; padding:12px 16px; font-size:1.1em;
    border-radius:var(--radius); border:none; margin:12px auto 20px auto;
    background:#344365; color:#fff; text-align:center;
  }
  input::placeholder { color:#bac3e6; }
  button,.buzzer-btn {
    background:var(--primary); color:#fff; font-weight:700;
    font-size:1.2em; border:none; border-radius:48px; padding:14px 18px;
    cursor:pointer; box-shadow:0 6px 13px #2554a180; margin:10px auto;
    display:block; min-width:160px; max-width:320px;
  }
  button:hover:not(:disabled) { background:var(--accent); color:#232323; }
  button:disabled { background:#888; color:#444; cursor:not-allowed; }
  .buzzer-btn {
    font-size:3rem; font-weight:900; padding:40px 80px;
    border-radius:90px; border:8px solid #fff; background:var(--accent); color:#222;
  }
  .backbtn {
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#364063; padding:10px 24px; border-radius:40px; color:#fff;
    box-shadow:0 5px 16px #000a; cursor:pointer; z-index:1000;
  }
  .center-box {
    background:#2b3250; padding:24px; border-radius:20px;
    box-shadow:0 4px 38px #232f66bb; display:flex; flex-direction:column; align-items:center;
  }
  .flex-main { display:flex; min-height:100vh; }
  .left-panel,.right-panel { flex:1; padding:1rem; }
  #question-img { max-width:90%; max-height:60vh; border-radius:16px; cursor:zoom-in; }
  #question-img.zoomed { transform:scale(2); cursor:zoom-out; z-index:2000; box-shadow:0 0 25px var(--accent); }
  #question-text { font-size:2rem; font-weight:700; text-align:center; margin-top:1rem; }
  .scoreboard { width:100%; max-width:420px; margin-top:1rem; background:#222947; border-radius:16px; padding:1rem; }
  .scoreboard table { width:100%; border-collapse:collapse; }
  .scoreboard th,.scoreboard td { border:1px solid #1a2138; padding:8px; text-align:center; }
  .scoreboard th { background:var(--primary); }
</style>
</head>
<body>
<button class="backbtn" id="backbtn" style="display:none;" onclick="backButtonHandler()">‚Üê Back</button>
<div id="modal" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:#ffcf46cc;padding:14px 24px;border-radius:12px;color:#232;font-weight:bold;display:none;z-index:1500"></div>

<!-- LOGIN -->
<div id="page-login" class="page show center-box">
  <h1>Login</h1>
  <input id="login-username" type="text" placeholder="Username" />
  <input id="login-password" type="password" placeholder="Password" />
  <button onclick="loginUser()">Login</button>
  <button onclick="showRegister()">Register</button>
</div>

<!-- REGISTER -->
<div id="page-register" class="page center-box">
  <h1>Register</h1>
  <input id="register-username" type="text" placeholder="Username" />
  <input id="register-password" type="password" placeholder="Password" />
  <input id="register-email" type="email" placeholder="Email" />
  <button onclick="registerUser()">Register</button>
  <button onclick="showLogin()">Back</button>
</div>

<!-- HOME -->
<div id="page-home" class="page center-box">
  <h2>Welcome, <span id="welcome-user"></span>!</h2>
  <button onclick="hostGame()">Host Game</button>
  <button onclick="showJoinPage()">Join Game</button>
  <button onclick="showProfile()">Profile</button>
  <button id="adminPanelBtn" style="display:none;" onclick="showAdminPanel()">Admin Panel</button>
  <button onclick="showScoreboard('player')">View Scoreboard</button>
</div>

<!-- PROFILE -->
<div id="page-profile" class="page center-box">
  <h2>Profile</h2>
  <input id="profile-email" type="email" placeholder="Email" />
  <input id="profile-password" type="password" placeholder="Change Password" />
  <button onclick="updateProfile()">Save</button>
</div>

<!-- ADMIN -->
<div id="page-admin-panel" class="page center-box">
  <h2>Admin Panel - <span id="room-code"></span></h2>
  <input id="admin-question-input" type="text" placeholder="Enter Question" />
  <input id="admin-image-input" type="file" accept="image/*" />
  <button onclick="uploadQuestion()">Upload Question</button>
  <table id="admin-scores" style="margin-top:1rem;width:100%;"></table>
  <button onclick="resetBuzzers()">Reset Buzzers</button>
  <button onclick="nextRound()">Next Round</button>
  <button onclick="showHome()">Back Home</button>
</div>

<!-- JOIN -->
<div id="page-join" class="page center-box">
  <h2>Join Game</h2>
  <input id="join-game-code" type="text" maxlength="6" placeholder="Game Code" />
  <input id="join-team" type="text" placeholder="Team (optional)" />
  <button onclick="joinGame()">Join</button>
  <button onclick="showHome()">Back</button>
</div>

<!-- PLAYER -->
<div id="page-player" class="page">
  <div class="flex-main">
    <div class="left-panel">
      <img id="question-img" alt="Question" />
      <div id="question-text"></div>
    </div>
    <div class="right-panel center-box">
      <button id="buzzer-btn" class="buzzer-btn">BUZZ!</button>
      <div id="buzz-lock-msg" style="font-weight:bold;margin-top:10px;"></div>
      <div>
        <button id="score-individual-btn">Individual Scores</button>
        <button id="score-team-btn">Team Scores</button>
      </div>
      <div id="scoreboard" class="scoreboard"></div>
      <div id="host-controls" style="display:none;margin-top:1rem;">
        <input id="host-team" type="text" placeholder="Team Name" />
        <input id="host-points" type="number" value="10" />
        <button id="host-add-points">Add Points</button>
      </div>
      <button style="margin-top: 16px;" onclick="leaveGame()">Leave Game</button>
    </div>
  </div>
</div>

<audio id="buzz-sound" src="https://cdn.pixabay.com/audio/2022/06/14/audio_123e37b08f.mp3" preload="auto"></audio>

<script>
// ---------- Firebase ---------- 
const firebaseConfig = {
  apiKey: "AIzaSyBHvyZyATvhJ1pMx-kV-_ZXFwXPb54VspI",
  authDomain: "buzzer-a0d53.firebaseapp.com",
  databaseURL: "https://buzzer-a0d53-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "buzzer-a0d53",
  storageBucket: "buzzer-a0d53.appspot.com",
  messagingSenderId: "29031182202",
  appId: "1:29031182202:web:447d951b38be59b29270c3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ------- Globals -------
let myUser=null,myPID=null,myTeam=null,gameID=null,isHost=false;
let pageStack=[];

// ------- Navigation -------
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('show'));
  document.getElementById(id).classList.add('show');
  pageStack.push(id);
  document.getElementById('backbtn').style.display = 
    (id==="page-login"||pageStack.length===1)?'none':'block';
}
function backButtonHandler(){
  if (pageStack.length>1){
    pageStack.pop();
    const prev=pageStack[pageStack.length-1];
    showPage(prev);
  }
}
function showLogin(){showPage("page-login");}
function showRegister(){showPage("page-register");}
function showHome(){showPage("page-home");}
function showProfile(){showPage("page-profile");}
function showAdminPanel(){showPage("page-admin-panel");}
function showJoinPage(){showPage("page-join");}
function showPlayerPage(){showPage("page-player");}
function showModal(msg,duration=2000){
  const m=document.getElementById("modal");
  m.textContent=msg; m.style.display="block";
  setTimeout(()=>m.style.display="none",duration);
}

// ------- Auth -------
function registerUser(){
  const u=document.getElementById("register-username").value.trim();
  const p=document.getElementById("register-password").value.trim();
  const e=document.getElementById("register-email").value.trim();
  if(!u||!p||!e){showModal("Fill all fields");return;}
  db.ref("users/"+u).get().then(s=>{
    if(s.exists()){showModal("Username exists");return;}
    db.ref("users/"+u).set({pw:p,email:e,role:"user"}).then(()=>{
      showModal("Registered! Login now."); showLogin();
    });
  });
}
function loginUser(){
  const u=document.getElementById("login-username").value.trim();
  const p=document.getElementById("login-password").value.trim();
  db.ref("users/"+u).get().then(s=>{
    if(!s.exists()){showModal("User not found");return;}
    const user=s.val();
    if(user.pw!==p){showModal("Wrong password");return;}
    myUser=u; myPID=btoa(u+Date.now()).slice(0,10);
    isHost=(u==="admin");
    document.getElementById("welcome-user").textContent=myUser;
    document.getElementById("adminPanelBtn").style.display=isHost?"block":"none";
    showHome();
  });
}

// ------- Host / Join -------
function hostGame(){
  gameID=Math.floor(100000+Math.random()*900000)+"";
  isHost=true; myPID=btoa(myUser+Date.now()).slice(0,12);
  db.ref("games/"+gameID).set({
    created:Date.now(),status:"live",round:1,question:"",image:"",
    buzzed:"",players:{}
  });
  document.getElementById("room-code").textContent=gameID;
  listenAdminGame(); showAdminPanel();
}
function joinGame(){
  const code=document.getElementById("join-game-code").value.trim();
  const team=document.getElementById("join-team").value.trim();
  if(!/^\d{6}$/.test(code)){showModal("Invalid code");return;}
  gameID=code; myPID=btoa(myUser+Date.now()).slice(0,12); myTeam=team||null;
  db.ref(`games/${gameID}/players/${myPID}`).set({
    name:myUser,team:myTeam,score:0,buzzed:false
  });
  listenPlayerGame(); showPlayerPage();
}

// ------- Admin -------
function uploadQuestion(){
  const q=document.getElementById("admin-question-input").value.trim();
  const file=document.getElementById("admin-image-input").files[0];
  if(!q){showModal("Enter question");return;}
  if(file){
    const r=new FileReader();
    r.onload=e=>{db.ref(`games/${gameID}`).update({question:q,image:e.target.result});
      showModal("Question uploaded");};
    r.readAsDataURL(file);
  } else {
    db.ref(`games/${gameID}`).update({question:q,image:""});
    showModal("Question uploaded");
  }
  document.getElementById("admin-question-input").value="";
  document.getElementById("admin-image-input").value="";
}
function resetBuzzers(){
  db.ref(`games/${gameID}/players`).once("value").then(s=>{
    s.forEach(ch=>db.ref(`games/${gameID}/players/${ch.key}`).update({buzzed:false}));
    db.ref(`games/${gameID}`).update({buzzed:""});
  });
}
function nextRound(){
  db.ref(`games/${gameID}`).once("value").then(s=>{
    let r=(s.val().round||1)+1;
    db.ref(`games/${gameID}`).update({round:r,buzzed:""});
    resetBuzzers();
  });
}
function reloadAdminScores(){
  db.ref(`games/${gameID}/players`).once("value").then(s=>{
    const players=Object.entries(s.val()||{});
    players.sort((a,b)=>(b[1].score||0)-(a.score||0));
    let html=`<thead><tr><th>Player</th><th>Team</th><th>Score</th></tr></thead><tbody>`;
    players.forEach(([pid,p])=>{
      html+=`<tr><td>${p.name}</td><td>${p.team||"-"}</td><td>${p.score||0}</td></tr>`;
    });
    html+="</tbody>";
    document.getElementById("admin-scores").innerHTML=html;
  });
}
function listenAdminGame(){
  db.ref(`games/${gameID}`).on("value",snap=>{
    const g=snap.val()||{};
    document.getElementById("question-text").textContent=g.question||"";
    if(g.image){document.getElementById("question-img").src=g.image;document.getElementById("question-img").style.display="block";}
    else document.getElementById("question-img").style.display="none";
    reloadAdminScores();
  });
}

// ------- Player -------
const buzzAudio=document.getElementById("buzz-sound");
const buzzerBtn=document.getElementById("buzzer-btn");
const buzzLockMsg=document.getElementById("buzz-lock-msg");
const scoreboardDiv=document.getElementById("scoreboard");
let buzzerLocked=false; let lastBuzz=0; let currentSB="individual";
function playBuzz(){buzzAudio.currentTime=0; buzzAudio.play();}
function tryBuzz(){
  if(buzzerLocked) return;
  const now=performance.now();
  if(now-lastBuzz<30) return; lastBuzz=now;
  db.ref(`games/${gameID}/players/${myPID}`).update({buzzed:true});
  db.ref(`games/${gameID}`).update({buzzed:myPID});
  playBuzz();
}
buzzerBtn.onclick=tryBuzz;
window.addEventListener("keydown",e=>{ if(e.code==="Space"||e.keyCode===32){ e.preventDefault(); tryBuzz(); } });

function listenPlayerGame(){
  db.ref(`games/${gameID}/buzzed`).on("value",snap=>{
    const b=snap.val();
    if(b&&b!==myPID){ buzzerLocked=true;buzzLockMsg.textContent="Buzzer Locked"; buzzerBtn.disabled=true; }
    else{ buzzerLocked=false;buzzLockMsg.textContent=""; buzzerBtn.disabled=false; }
  });
  loadScoreboard("individual");
}
function loadScoreboard(mode){
  currentSB=mode;
  db.ref(`games/${gameID}/players`).once("value").then(s=>{
    const players=Object.values(s.val()||{});
    let html="";
    if(mode==="individual"){
      players.sort((a,b)=>(b.score||0)-(a.score||0));
      html=`<table><tr><th>Player</th><th>Team</th><th>Score</th></tr>`;
      players.forEach(p=>{html+=`<tr><td>${p.name}</td><td>${p.team||"-"}</td><td>${p.score||0}</td></tr>`;});
      html+="</table>";
    } else {
      const teams={};
      players.forEach(p=>{ if(p.team) teams[p.team]=(teams[p.team]||0)+(p.score||0); });
      html="<table><tr><th>Team</th><th>Score</th></tr>";
      Object.entries(teams).sort((a,b)=>b[1]-a)
        .forEach(([t,s])=>{html+=`<tr><td>${t}</td><td>${s}</td></tr>`;});
      html+="</table>";
    }
    scoreboardDiv.innerHTML=html;
  });
}
document.getElementById("score-individual-btn").onclick=()=>loadScoreboard("individual");
document.getElementById("score-team-btn").onclick=()=>loadScoreboard("team");
document.getElementById("host-add-points").onclick=()=>{
  const t=document.getElementById("host-team").value.trim();
  const pts=parseInt(document.getElementById("host-points").value);
  db.ref(`games/${gameID}/players`).once("value").then(s=>{
    s.forEach(ch=>{
      const p=ch.val();
      if(p.team===t) db.ref(`games/${gameID}/players/${ch.key}/score`).transaction(x=>(x||0)+pts);
    });
    loadScoreboard(currentSB);
  });
};
function leaveGame(){
  db.ref(`games/${gameID}/players/${myPID}`).remove();
  showLogin();
}
document.getElementById("question-img").onclick=function(){this.classList.toggle("zoomed");};

</script>
</body>
</html>
